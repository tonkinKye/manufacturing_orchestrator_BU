<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Setup - Manufacturing Orchestrator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
  <style>
    .setup-container {
      max-width: 800px;
      margin: 50px auto;
    }
    .setup-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .setup-panel {
      margin-bottom: 20px;
    }
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    .test-result.success {
      background-color: #dff0d8;
      border: 1px solid #d6e9c6;
      color: #3c763d;
    }
    .test-result.error {
      background-color: #f2dede;
      border: 1px solid #ebccd1;
      color: #a94442;
    }
    .icon {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      margin-right: 5px;
    }
    .btn-test {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container setup-container">
    <div class="setup-header">
      <h2><img src="images/factory.svg" class="icon" style="width: 40px; height: 40px;" alt="Factory"> Manufacturing Orchestrator</h2>
      <h3>Initial Setup</h3>
      <p class="text-muted">Configure your Fishbowl and MySQL credentials to get started</p>
    </div>

    <!-- Fishbowl Configuration -->
    <div class="panel panel-primary setup-panel">
      <div class="panel-heading">
        <h4><img src="images/gear.svg" class="icon" alt="Settings"> Fishbowl Configuration</h4>
      </div>
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-6">
            <label>Server URL:</label>
            <input id="fishbowlUrl" type="text" class="form-control" placeholder="https://your-server:28192">
            <small class="text-muted">Example: https://localhost:28192</small>
          </div>
          <div class="col-sm-6">
            <label>Username:</label>
            <input id="fishbowlUsername" type="text" class="form-control" placeholder="admin">
          </div>
        </div>
        <div class="row" style="margin-top: 10px;">
          <div class="col-sm-6">
            <label>Password:</label>
            <input id="fishbowlPassword" type="password" class="form-control" placeholder="Password">
          </div>
          <div class="col-sm-6">
            <label>Database: <span class="text-muted">(auto-detected)</span></label>
            <input id="fishbowlDatabase" type="text" class="form-control" placeholder="Will be auto-fetched" readonly>
          </div>
        </div>

        <button id="btnTestFishbowl" class="btn btn-info btn-test">
          <img src="images/lightning.svg" class="icon" alt="Test"> Test Connection & Fetch Database
        </button>

        <div id="fishbowlTestResult" class="test-result" style="display:none;"></div>
      </div>
    </div>

    <!-- MySQL Configuration -->
    <div class="panel panel-info setup-panel">
      <div class="panel-heading">
        <h4><img src="images/clipboard.svg" class="icon" alt="Database"> MySQL Configuration</h4>
      </div>
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-6">
            <label>Host:</label>
            <input id="mysqlHost" type="text" class="form-control" value="localhost" placeholder="localhost">
          </div>
          <div class="col-sm-6">
            <label>Port:</label>
            <input id="mysqlPort" type="number" class="form-control" value="3306" placeholder="3306">
          </div>
        </div>
        <div class="row" style="margin-top: 10px;">
          <div class="col-sm-6">
            <label>Username:</label>
            <input id="mysqlUser" type="text" class="form-control" value="root" placeholder="root">
          </div>
          <div class="col-sm-6">
            <label>Password:</label>
            <input id="mysqlPassword" type="password" class="form-control" placeholder="MySQL password">
          </div>
        </div>
      </div>
    </div>

    <!-- Setup Actions -->
    <div class="panel panel-success setup-panel">
      <div class="panel-body">
        <div class="row">
          <div class="col-sm-12">
            <button id="btnCompleteSetup" class="btn btn-success btn-lg btn-block" disabled>
              <img src="images/lock.svg" class="icon" alt="Save"> Complete Setup & Encrypt Configuration
            </button>
            <p class="text-center text-muted" style="margin-top: 10px;">
              <small>
                <strong>Security Note:</strong> All credentials will be encrypted using Windows DPAPI
                (Data Protection API) and stored securely. The encryption key is protected by your
                Windows user account and cannot be decrypted by other users.
              </small>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="setupStatus" style="display:none;"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      let fishbowlTested = false;

      // Test Fishbowl Connection
      $('#btnTestFishbowl').click(async function() {
        const url = $('#fishbowlUrl').val().trim();
        const username = $('#fishbowlUsername').val().trim();
        const password = $('#fishbowlPassword').val();

        if (!url || !username || !password) {
          showFishbowlResult('error', 'Please fill in all Fishbowl fields');
          return;
        }

        $(this).prop('disabled', true).html('<span class="glyphicon glyphicon-refresh glyphicon-spin"></span> Testing...');

        try {
          const response = await fetch('/api/setup/test-fishbowl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              serverUrl: url,
              username: username,
              password: password
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            $('#fishbowlDatabase').val(data.database || 'N/A');
            showFishbowlResult('success', '✓ Connection successful! Database: ' + (data.database || 'N/A'));
            fishbowlTested = true;
            updateSetupButton();
          } else {
            showFishbowlResult('error', '✗ ' + (data.error || 'Connection failed'));
            fishbowlTested = false;
            updateSetupButton();
          }
        } catch (err) {
          showFishbowlResult('error', '✗ Connection error: ' + err.message);
          fishbowlTested = false;
          updateSetupButton();
        }

        $(this).prop('disabled', false).html('<img src="images/lightning.svg" class="icon" alt="Test"> Test Connection & Fetch Database');
      });

      function showFishbowlResult(type, message) {
        $('#fishbowlTestResult')
          .removeClass('success error')
          .addClass(type)
          .html(message)
          .show();
      }

      function updateSetupButton() {
        const mysqlHost = $('#mysqlHost').val().trim();
        const mysqlUser = $('#mysqlUser').val().trim();
        const mysqlPassword = $('#mysqlPassword').val();

        const allFieldsFilled = fishbowlTested && mysqlHost && mysqlUser && mysqlPassword;

        $('#btnCompleteSetup').prop('disabled', !allFieldsFilled);
      }

      // Monitor form changes
      $('#mysqlHost, #mysqlUser, #mysqlPassword').on('input', updateSetupButton);

      // Complete Setup
      $('#btnCompleteSetup').click(async function() {
        $(this).prop('disabled', true).html('<span class="glyphicon glyphicon-refresh glyphicon-spin"></span> Saving & Encrypting...');

        const config = {
          fishbowl: {
            serverUrl: $('#fishbowlUrl').val().trim(),
            username: $('#fishbowlUsername').val().trim(),
            password: $('#fishbowlPassword').val(),
            database: $('#fishbowlDatabase').val() || null
          },
          mysql: {
            host: $('#mysqlHost').val().trim(),
            port: parseInt($('#mysqlPort').val()) || 3306,
            user: $('#mysqlUser').val().trim(),
            password: $('#mysqlPassword').val()
          }
        };

        try {
          const response = await fetch('/api/setup/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });

          const data = await response.json();

          if (response.ok && data.success) {
            $('#setupStatus')
              .removeClass('alert-danger')
              .addClass('alert alert-success')
              .html('<strong>Success!</strong> Configuration saved and encrypted. Redirecting...')
              .show();

            setTimeout(() => {
              window.location.href = '/index.html';
            }, 1500);
          } else {
            $('#setupStatus')
              .removeClass('alert-success')
              .addClass('alert alert-danger')
              .html('<strong>Error:</strong> ' + (data.error || 'Setup failed'))
              .show();

            $(this).prop('disabled', false).html('<img src="images/lock.svg" class="icon" alt="Save"> Complete Setup & Encrypt Configuration');
          }
        } catch (err) {
          $('#setupStatus')
            .removeClass('alert-success')
            .addClass('alert alert-danger')
            .html('<strong>Error:</strong> ' + err.message)
            .show();

          $(this).prop('disabled', false).html('<img src="images/lock.svg" class="icon" alt="Save"> Complete Setup & Encrypt Configuration');
        }
      });
    });
  </script>
</body>
</html>
