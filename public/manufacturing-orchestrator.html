<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manufacturing Orchestrator</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha512-Dop/vW3iOtayerlYAqCgkVr2aTr2ErwwTYOvRFUpzl2VhCMJyjQF0Q9TjUXIo6JhuM/3i0vVEt2e/7QQmnHQqw==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    body { padding: 20px; }
    .step-panel { margin-bottom: 20px; }
    .step-panel.disabled { opacity: 0.5; pointer-events: none; }
    .step-number { display: inline-block; width: 35px; height: 35px; line-height: 35px; text-align: center; background: #5cb85c; color: white; border-radius: 50%; font-weight: bold; margin-right: 10px; }
    #log { max-height: 300px; overflow: auto; background: #111; color: #eee; padding: 12px; margin: 0; font-family: monospace; font-size: 12px; line-height: 1.5; white-space: pre-wrap; }
    .summary-box { background: #f9f9f9; padding: 15px; border-left: 4px solid #5cb85c; border-radius: 4px; margin-top: 15px; }
    .chunk-preview { max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; }
    .csv-preview-table { width: 100%; font-size: 12px; margin-top: 8px; }
    .csv-preview-table th { background: #f0f0f0; font-weight: bold; padding: 6px; border: 1px solid #ddd; }
    .csv-preview-table td { padding: 6px; border: 1px solid #ddd; font-family: monospace; }
    .config-panel { background: #e7f3ff; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #b3d9ff; }
    .validation-issues { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-top: 15px; border-radius: 4px; }
    .queue-stats { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin-top: 15px; border-radius: 4px; }
    .reconnect-banner { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
    .icon { height: 16px; width: 16px; vertical-align: middle; margin-right: 4px; display: inline-block; }
    .icon { height: 16px; width: 16px; vertical-align: middle; margin-right: 4px; display: inline-block; }
    .icon { height: 16px; width: 16px; vertical-align: middle; margin-right: 4px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h2><img src="images/factory.svg" class="icon" alt="Factory"> Manufacturing Orchestrator</h2>
    
    <!-- Reconnection Banner (hidden by default) -->
    <div id="reconnectBanner" class="reconnect-banner" style="display:none;">
      <strong><img src="images/lightning.svg" class="icon" alt="Fast"> Reconnected to Active Job</strong><br>
      A job was already running on the server. Displaying live progress below.
    </div>
    
    <!-- API Configuration -->
    <div class="config-panel">
      <h4><img src="images/gear.svg" class="icon" alt="Settings"> Fishbowl Login</h4>
      <div class="row">
        <div class="col-sm-6">
          <label>Fishbowl Server URL:</label>
          <input id="serverUrl" type="text" class="form-control" value="http://localhost:2480" placeholder="https://your-server:2456">
        </div>
        <div class="col-sm-6">
          <label>Username:</label>
          <input id="username" type="text" class="form-control" value="admin" placeholder="Username">
        </div>
      </div>
      <div class="row" style="margin-top: 10px;">
        <div class="col-sm-6">
          <label>Password:</label>
          <input id="password" type="password" class="form-control" value="admin" placeholder="Password">
        </div>
        <div class="col-sm-6">
          <label>Session Status:</label>
          <div style="padding-top: 7px;">
            <span id="sessionStatus" class="text-muted">Not logged in</span>
          </div>
        </div>
      </div>

      <div style="margin-top: 10px;">
        <button id="btnLogin" class="btn btn-success btn-sm"><img src="images/lock.svg" class="icon" alt="Login"> Login</button>
        <button id="btnLogout" class="btn btn-danger btn-sm" style="display:none;"><img src="images/door.svg" class="icon" alt="Logout"> Logout</button>
      </div>
      
    </div>
    
    <hr>
    
    <!-- STEP 1: Configure Work Order(s) -->
    <div class="panel panel-success step-panel disabled" id="step1">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep1" aria-expanded="false">
            <span class="step-number">1</span>Configure Work Order(s)
          </a>
        </h4>
      </div>
      <div id="collapseStep1" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <div class="row">
            <div class="col-sm-6">
              <label>Select Location Group:</label>
              <select id="locationGroupSelect" class="form-control"><option value="">Loading location groups...</option></select>
            </div>
            <div class="col-sm-6">
              <label>Select BOM:</label>
              <select id="bomSelect" class="form-control" disabled><option value=""><img src="images/clipboard.svg" class="icon" alt="Clipboard"> First select a location group</option></select>
            </div>
          </div>
          <div class="row" style="margin-top: 15px;">
            <div class="col-sm-12">
              <button id="btnSelectBOM" class="btn btn-success btn-block" disabled>Configure Work Orders</button>
            </div>
          </div>
          <div id="bomInfo" class="summary-box" style="display:none;">
            <strong>Location Group:</strong> <span id="selectedLocationGroup"></span><br>
            <strong>BOM:</strong> <span id="selectedBOM"></span><br>
            <strong>Default FG Location:</strong> <span id="selectedDefaultLocation"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 1.5: Choose Operation Type -->
    <div class="panel panel-warning step-panel disabled" id="step1_5">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep1_5" aria-expanded="false">
            <span class="step-number">1.5</span>Choose Operation Type
          </a>
        </h4>
      </div>
      <div id="collapseStep1_5" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <div class="row">
            <div class="col-sm-6">
              <div class="panel panel-success" style="cursor: pointer;" id="panelBuild">
                <div class="panel-body text-center" style="padding: 40px;">
                  <h3><img src="images/wrench.svg" class="icon" alt="Build"> BUILD</h3>
                  <p>Assemble raw goods into finished goods</p>
                  <p><small>Upload CSV with serial numbers → Create MOs → Pick & Finish</small></p>
                </div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="panel panel-info" style="cursor: pointer;" id="panelDisassemble">
                <div class="panel-body text-center" style="padding: 40px;">
                  <h3><img src="images/package.svg" class="icon" alt="Disassemble"> DISASSEMBLE</h3>
                  <p>Break down finished goods into raw goods</p>
                  <p><small>Select finished goods → Create disassembly MOs → Return materials</small></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2: Drop CSV File (BUILD path) -->
    <div class="panel panel-primary step-panel disabled" id="step2">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep2" aria-expanded="false">
            <span class="step-number">2</span>Upload CSV File
          </a>
        </h4>
      </div>
      <div id="collapseStep2" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <div class="form-group">
            <label>CSV File (SerialNumber, Barcode):</label>
            <input id="csvFile" type="file" accept=".csv" class="form-control">
            <small class="help-block">File should contain serial numbers and finished good barcodes</small>
          </div>
          <div id="csvInfo" class="summary-box" style="display:none;">
            <strong>File Loaded:</strong> <span id="csvFileName"></span><br>
            <strong>Rows:</strong> <span id="csvRowCount"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2B: Select Finished Goods (DISASSEMBLE path) -->
    <div class="panel panel-info step-panel disabled" id="step2b" style="display:none;">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep2b" aria-expanded="false">
            <span class="step-number">2</span>Select Finished Goods for Disassembly
          </a>
        </h4>
      </div>
      <div id="collapseStep2b" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <p class="help-block">
            <img src="images/info.svg" class="icon" alt="Info">
            Select finished goods to disassemble. Only items built using the selected BOM are shown.
          </p>

          <div class="row">
            <!-- Available FG List -->
            <div class="col-sm-5">
              <div class="panel panel-default">
                <div class="panel-heading">
                  <strong>Available Finished Goods (<span id="availableFGCount">0</span>)</strong>
                  <div class="input-group input-group-sm" style="margin-top: 10px;">
                    <span class="input-group-addon"><img src="images/search.svg" class="icon" alt="Search"></span>
                    <input type="text" id="fgSearchBox" class="form-control" placeholder="Search by barcode, part number...">
                  </div>
                </div>
                <div class="panel-body" style="padding: 0;">
                  <div id="availableFGList" style="height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <div style="padding: 20px; text-align: center; color: #999;">
                      Loading...
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Transfer Buttons -->
            <div class="col-sm-2 text-center" style="padding-top: 150px;">
              <button id="btnAddAllFG" class="btn btn-sm btn-default btn-block" title="Add All">
                <img src="images/chevron-right.svg" class="icon" alt="Add All"> All
              </button>
              <button id="btnAddSelectedFG" class="btn btn-sm btn-primary btn-block" title="Add Selected" style="margin-top: 10px;">
                <img src="images/chevron-right.svg" class="icon" alt="Add">
              </button>
              <button id="btnRemoveSelectedFG" class="btn btn-sm btn-warning btn-block" title="Remove Selected" style="margin-top: 30px;">
                <img src="images/chevron-left.svg" class="icon" alt="Remove">
              </button>
              <button id="btnRemoveAllFG" class="btn btn-sm btn-default btn-block" title="Remove All" style="margin-top: 10px;">
                <img src="images/chevron-left.svg" class="icon" alt="Remove All"> All
              </button>
            </div>

            <!-- Selected FG List -->
            <div class="col-sm-5">
              <div class="panel panel-success">
                <div class="panel-heading">
                  <strong>Selected for Disassembly (<span id="selectedFGCount">0</span>)</strong>
                </div>
                <div class="panel-body" style="padding: 0;">
                  <div id="selectedFGList" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; background: #f9f9f9;">
                    <div style="padding: 20px; text-align: center; color: #999;">
                      No items selected
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top: 20px;">
            <div class="col-sm-12">
              <div class="form-group">
                <label>Raw Goods Return Location:</label>
                <select id="fgReturnLocation" class="form-control">
                  <option value="">Loading locations...</option>
                </select>
                <small class="help-block">Where to return the raw goods after disassembly</small>
              </div>
            </div>
          </div>

          <button id="btnConfirmDisassembly" class="btn btn-success btn-block" disabled>
            Confirm & Queue for Disassembly
          </button>
        </div>
      </div>
    </div>

    <!-- STEP 3: Map Headers & Validate (BUILD path) -->
    <div class="panel panel-info step-panel disabled" id="step3">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep3" aria-expanded="false">
            <span class="step-number">3</span>Map CSV Columns & Validate
          </a>
        </h4>
      </div>
      <div id="collapseStep3" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <div class="well well-sm">
            <strong>CSV Preview (first 3 rows):</strong>
            <div id="csvPreview" style="overflow-x: auto; max-height: 200px;"></div>
          </div>
          <div class="row">
            <div class="col-sm-3">
              <div class="form-group">
                <label>Serial Number Column:</label>
                <select id="serialColumn" class="form-control"></select>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="form-group">
                <label>Barcode Column:</label>
                <select id="barcodeColumn" class="form-control"></select>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="form-group">
                <label>Raw Good Part (for Serial Allocation):</label>
                <select id="rawGoodPart" class="form-control"><option value="">Loading...</option></select>
              </div>
            </div>
            <div class="col-sm-3">
              <div class="form-group">
                <label>Finished Good Location:</label>
                <select id="fgLocation" class="form-control"><option value="">Loading locations...</option></select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="hasHeaders" checked> First row contains headers</label>
          </div>
          <button id="btnValidate" class="btn btn-info btn-block">Validate & Queue for Processing</button>
          
          <div id="validationResults" style="display:none; margin-top:20px;">
            <div id="validationSummary" class="summary-box"></div>
            <div id="validationIssues" class="validation-issues" style="display:none;"></div>
            <div style="margin-top:15px;">
              <button id="btnSaveToQueue" class="btn btn-success btn-lg btn-block" style="display:none;"><img src="images/check.svg" class="icon" alt="Success"> Save Valid Items to Queue & Continue</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- STEP 4: Process Queue -->
    <div class="panel panel-warning step-panel disabled" id="step4">
      <div class="panel-heading" role="tab">
        <h4 class="panel-title">
          <a role="button" data-toggle="collapse" href="#collapseStep4" aria-expanded="false">
            <span class="step-number">4</span>Process Queue
          </a>
        </h4>
      </div>
      <div id="collapseStep4" class="panel-collapse collapse" role="tabpanel">
        <div class="panel-body">
          <div id="queueStats" class="queue-stats">
            <strong>Current Job Status:</strong><br>
            <div id="queueStatsContent">Loading...</div>
          </div>
          <div class="well well-sm" style="margin-top:15px;">
            <strong>Processing Plan:</strong><br>
            <img src="images/play.svg" class="icon" alt="Process"> Processes all <strong>Pending</strong> items in queue<br>
            <img src="images/package.svg" class="icon" alt="Package"> Work Orders grouped into MOs of 100 WOs each<br>
            <img src="images/hash.svg" class="icon" alt="Number"> MO naming: <code>BOMNum|YYMMDD|#</code> (e.g., RCH001|251023|1)<br>
            <img src="images/save.svg" class="icon" alt="Save"> Progress saved to database (fault-tolerant)<br>
            <img src="images/refresh.svg" class="icon" alt="Refresh"> Failed items auto-retry once<br>
          </div>
          <button id="btnProcess" class="btn btn-warning btn-lg btn-block"><img src="images/factory.svg" class="icon" alt="Factory"> Process Queue</button>
          <div id="processResults" style="display:none; margin-top:20px;">
            <div id="processResultContent"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- LOG -->
    <div class="panel panel-default">
      <div class="panel-heading">
        <strong>Operation Log</strong>
        <button type="button" id="btnClearLog" class="btn btn-xs btn-default pull-right">Clear</button>
      </div>
      <div class="panel-body" style="padding:0;">
        <pre id="log"></pre>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha512-oBTprMeNEKCnqfuqKd6sbvFzmFQtlXS3e0C/RGFV0hD6QzhHV+ODfaQbAlmY6/q0ubbwlAM/nCJjkrgA3waLzg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script>
    'use strict';
    
    // ============================================================================
    // GLOBAL STATE & UTILITIES
    // ============================================================================
    
    let sessionToken = null;
    let sessionCredentials = { username: '', password: '', database: '' };
    
    let state = {
      locationGroup: null,
      bom: null,
      bomId: null,
      bomDefaultLocation: null,
      csvData: null,
      mapping: null,
      chunks: null,
      validationResults: null,
      operationType: null, // 'build' or 'disassemble'
      finishedGoods: [], // For disassembly: available FG list
      selectedFinishedGoods: [] // For disassembly: selected FG list
    };
    
    // ============================================================================
    // SESSION PERSISTENCE
    // ============================================================================
    
    function saveSessionToStorage() {
      try {
        localStorage.setItem('mo_session', JSON.stringify({
          token: sessionToken,
          serverUrl: document.getElementById('serverUrl').value,
          username: sessionCredentials.username,
          password: sessionCredentials.password,
          database: sessionCredentials.database,
          timestamp: Date.now()
        }));
        log('[SESSION] Session saved to browser storage\n');
      } catch (e) {
        log(`[WARN] Could not save session: ${e.message}\n`);
      }
    }
    
    function loadSessionFromStorage() {
      try {
        const stored = localStorage.getItem('mo_session');
        if (!stored) return null;
        
        const session = JSON.parse(stored);
        
        // Check if session is less than 24 hours old
        const age = Date.now() - session.timestamp;
        if (age > 24 * 60 * 60 * 1000) {
          log('[SESSION] Stored session expired (>24 hours)\n');
          localStorage.removeItem('mo_session');
          return null;
        }
        
        return session;
      } catch (e) {
        log(`[WARN] Could not load session: ${e.message}\n`);
        return null;
      }
    }
    
    function clearSessionFromStorage() {
      try {
        localStorage.removeItem('mo_session');
        log('[SESSION] Session cleared from browser storage\n');
      } catch (e) {
        log(`[WARN] Could not clear session: ${e.message}\n`);
      }
    }
    
    const log = (msg) => {
      const el = document.getElementById('log');
      if (el) {
        el.textContent += msg.endsWith('\n') ? msg : `${msg}\n`;
        el.scrollTop = el.scrollHeight;
      }
      console.log('[LOG]', msg);
    };
    
    const kv = (row, key) => {
      if (!row) return undefined;
      const val = row[key] ?? row[key?.toUpperCase?.()] ?? row[key?.toLowerCase?.()];
      if (val === undefined && row.Row) {
        return row.Row[key] ?? row.Row[key?.toUpperCase?.()] ?? row.Row[key?.toLowerCase?.()];
      }
      return val;
    };
    
    const enableStep = (stepNum) => {
      const step = document.getElementById(`step${stepNum}`);
      step.classList.remove('disabled');
      step.style.opacity = '1';
      step.style.pointerEvents = 'auto';
      $(`#collapseStep${stepNum}`).collapse('show');

      // Hide previous step based on current step
      // Map: 1_5 -> hide 1, 2 -> hide 1_5, 2b -> hide 1_5, 3 -> hide 2, 4 -> hide 3
      const previousSteps = {
        '1_5': '1',
        '2': '1_5',
        '2b': '1_5',
        '3': '2',
        '4': '3'
      };

      if (previousSteps[stepNum]) {
        $(`#collapseStep${previousSteps[stepNum]}`).collapse('hide');
      } else if (typeof stepNum === 'number' && stepNum > 1) {
        $(`#collapseStep${stepNum - 1}`).collapse('hide');
      }
    };
    
    const populateSelect = (id, options, placeholder = '<img src="images/clipboard.svg" class="icon" alt="Clipboard"> Select') => {
      document.getElementById(id).innerHTML = `<option value="">${placeholder}</option>` + options.join('');
    };
    
    // ============================================================================
    // CONFIG MANAGEMENT
    // ============================================================================
    
    async function loadConfig() {
      try {
        log('[CONFIG] Loading saved configuration...\n');
        const response = await fetch('/api/load-config');
        if (response.ok) {
          const config = await response.json();
          if (config.serverUrl) {
            document.getElementById('serverUrl').value = config.serverUrl;
            document.getElementById('username').value = config.username || '';
            document.getElementById('password').value = config.password || '';
            
            log('[OK] Loaded saved Fishbowl credentials\n');
          } else {
            log('[INFO] No saved config found (first run)\n');
          }
        } else {
          log('[INFO] No saved config found (first run)\n');
        }
      } catch (e) {
        log(`[INFO] No saved config found: ${e.message}\n`);
      }
    }
    
    async function saveConfig(config) {
      try {
        await fetch('/api/save-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: config.serverUrl,
            username: config.username,
            password: config.password,
            database: config.database
          })
        });
        log('[CONFIG] Configuration saved for next session\n');
      } catch (e) {
        log(`[WARN] Could not save config: ${e.message}\n`);
      }
    }
    
    // ============================================================================
    // SESSION MANAGEMENT
    // ============================================================================
    
    async function login() {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      
      if (!serverUrl || !username || !password) {
        return alert('Please enter server URL, username, and password');
      }
      
      const statusEl = document.getElementById('sessionStatus');
      statusEl.innerHTML = '<span class="text-info"><img src="images/spinner.svg" class="icon" alt="Loading"> Logging in...</span>';
      
      try {
        log('[LOGIN] Logging in to Fishbowl via proxy...\n');
        
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: serverUrl,
            appName: 'ManufacturingOrchestrator',
            appId: 20251022,
            username: username,
            password: password,
            mfaCode: ''
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        if (!data.token) {
          throw new Error('Login succeeded but no token received');
        }
        
        sessionToken = data.token;

        // Clear any previous job results on new login
        document.getElementById('processResults').style.display = 'none';
        document.getElementById('processResultContent').innerHTML = '';
        log('[LOGIN] Cleared previous job results\n');

        statusEl.innerHTML = `<span class="text-success"><img src="images/check.svg" class="icon" alt="Success"> Logged in as ${username}</span>`;
        document.getElementById('btnLogin').style.display = 'none';
        document.getElementById('btnLogout').style.display = 'inline-block';

        document.getElementById('serverUrl').disabled = true;
        document.getElementById('username').disabled = true;
        document.getElementById('password').disabled = true;

        log(`[OK] Login successful! Token: ${sessionToken.substring(0, 20)}...\n`);

        log('[DB] Detecting database name via Fishbowl...\n');
        const databaseName = await detectDatabaseName();
        log(`[OK] Database detected: ${databaseName}\n`);

        // Store credentials including database
        sessionCredentials = { username, password, database: databaseName };

        // Save session to browser storage (now with database)
        saveSessionToStorage();
        
        await saveConfig({ serverUrl, username, password, database: databaseName });
        log('[CONFIG] Credentials and database name saved securely\n');
        
        await initializeQueueTable(databaseName);
        
        // Enable Step 1 now that we're logged in
        document.getElementById('step1').classList.remove('disabled');
        document.getElementById('step1').style.opacity = '1';
        document.getElementById('step1').style.pointerEvents = 'auto';
        $('#collapseStep1').collapse('show');
        log('[OK] Step 1 enabled - ready to configure work orders\n');
        
        await loadLocationGroups();

        // Check for pending jobs from previous interrupted run
        log('[LOGIN] Checking for pending jobs from previous session...\n');
        const shouldResume = await checkForPendingJobs();

        if (shouldResume) {
          // User wants to resume - redirect to step 4 to process queue
          log('[LOGIN] User chose to resume pending jobs\n');
          enableStep(4);
          await updateQueueStats();
          $('#collapseStep1').collapse('hide');
          $('#collapseStep4').collapse('show');
        }

      } catch (e) {
        statusEl.innerHTML = '<span class="text-danger"><img src="images/x.svg" class="icon" alt="Error"> Login failed</span>';
        log(`[ERROR] Login failed: ${e.message}\n`);
        alert(`Login failed: ${e.message}\n\nMake sure:\n1. Node.js proxy server is running (node server.js)\n2. Fishbowl server URL is correct\n3. Username and password are valid`);
      }
    }
    
    function resetPage(preserveResults = false) {
      log('[RESET] Resetting page to initial state' + (preserveResults ? ' (preserving results)' : '') + '...\n');
      
      // Reset state variables
      state = {
        locationGroup: null,
        bom: null,
        bomId: null,
        bomDefaultLocation: null,
        csvData: null,
        mapping: null,
        chunks: null,
        validationResults: null,
        operationType: null,
        finishedGoods: [],
        selectedFinishedGoods: []
      };
      
      // Reset Step 1
      document.getElementById('locationGroupSelect').innerHTML = '<option value="">Loading location groups...</option>';
      document.getElementById('bomSelect').innerHTML = '<option value=""><img src="images/clipboard.svg" class="icon" alt="Clipboard"> First select a location group</option>';
      document.getElementById('bomSelect').disabled = true;
      document.getElementById('btnSelectBOM').disabled = true;
      document.getElementById('bomInfo').style.display = 'none';
      
      // Reset Step 1.5 (operation type selection)
      document.getElementById('panelBuild').style.border = '1px solid #ddd';
      document.getElementById('panelDisassemble').style.border = '1px solid #ddd';

      // Reset Step 2
      document.getElementById('csvFile').value = '';
      document.getElementById('csvInfo').style.display = 'none';

      // Reset Step 2B (disassembly)
      document.getElementById('availableFGList').innerHTML = '';
      document.getElementById('selectedFGList').innerHTML = '';
      document.getElementById('fgReturnLocation').innerHTML = '<option value="">Select return location for raw goods</option>';
      document.getElementById('availableFGCount').textContent = '0';
      document.getElementById('selectedFGCount').textContent = '0';
      document.getElementById('btnConfirmDisassembly').disabled = true;
      
      // Reset Step 3
      document.getElementById('csvPreview').innerHTML = '';
      document.getElementById('serialColumn').innerHTML = '';
      document.getElementById('barcodeColumn').innerHTML = '';
      document.getElementById('fgLocation').innerHTML = '<option value="">Loading locations...</option>';
      document.getElementById('hasHeaders').checked = true;
      document.getElementById('validationResults').style.display = 'none';
      document.getElementById('btnSaveToQueue').style.display = 'none';
      
      // Reset Step 4 - but preserve results if requested
      document.getElementById('queueStatsContent').innerHTML = 'Loading...';
      if (!preserveResults) {
        document.getElementById('processResults').style.display = 'none';
        document.getElementById('processResultContent').innerHTML = '';
      }
      document.getElementById('btnProcess').disabled = false;
      document.getElementById('btnProcess').innerHTML = '<img src="images/factory.svg" class="icon" alt="Factory"> Process Queue';
      document.getElementById('btnProcess').classList.remove('btn-default');
      document.getElementById('btnProcess').classList.add('btn-warning');
      
      // Stop any active polling
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      
      // Disable and collapse ALL steps (including step 1, 1_5, 2b)
      document.getElementById('step1').classList.add('disabled');
      document.getElementById('step1_5').classList.add('disabled');
      document.getElementById('step2').classList.add('disabled');
      document.getElementById('step2b').classList.add('disabled');
      document.getElementById('step3').classList.add('disabled');
      document.getElementById('step4').classList.add('disabled');

      // Reset all steps to disabled visual state
      document.getElementById('step1').style.opacity = '0.5';
      document.getElementById('step1').style.pointerEvents = 'none';
      document.getElementById('step1_5').style.opacity = '0.5';
      document.getElementById('step1_5').style.pointerEvents = 'none';
      document.getElementById('step2').style.opacity = '0.5';
      document.getElementById('step2').style.pointerEvents = 'none';
      document.getElementById('step2b').style.opacity = '0.5';
      document.getElementById('step2b').style.pointerEvents = 'none';
      document.getElementById('step3').style.opacity = '0.5';
      document.getElementById('step3').style.pointerEvents = 'none';
      document.getElementById('step4').style.opacity = '0.5';
      document.getElementById('step4').style.pointerEvents = 'none';

      // Collapse all accordions
      $('#collapseStep1').collapse('hide');
      $('#collapseStep1_5').collapse('hide');
      $('#collapseStep2').collapse('hide');
      $('#collapseStep2b').collapse('hide');
      $('#collapseStep3').collapse('hide');
      $('#collapseStep4').collapse('hide');
      
      // Hide reconnection banner
      document.getElementById('reconnectBanner').style.display = 'none';
      
      // Re-enable config panel
      const configPanel = document.querySelector('.config-panel');
      configPanel.style.opacity = '1';
      configPanel.style.pointerEvents = 'auto';
      
      log('[RESET] Page reset complete - please login to continue\n');
    }
    
    async function logout(preserveResults = false) {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      
      if (!sessionToken) {
        return;
      }
      
      try {
        log('[LOGOUT] Logging out...\n');
        
        await fetch('/api/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: serverUrl,
            token: sessionToken,
            appName: 'ManufacturingOrchestrator',
            appId: 20251022,
            username: sessionCredentials.username,
            password: sessionCredentials.password
          })
        });
        
        log('[OK] Logged out successfully\n');
        
      } catch (e) {
        log(`[WARN] Logout error (non-critical): ${e.message}\n`);
      } finally {
        sessionToken = null;
        sessionCredentials = { username: '', password: '', database: '' };
        
        // Clear session from storage
        clearSessionFromStorage();
        
        document.getElementById('sessionStatus').innerHTML = '<span class="text-muted">Not logged in</span>';
        document.getElementById('btnLogin').style.display = 'inline-block';
        document.getElementById('btnLogin').disabled = false; // Re-enable the button
        document.getElementById('btnLogout').style.display = 'none';
        document.getElementById('btnLogout').disabled = false; // Re-enable for next login
        
        document.getElementById('serverUrl').disabled = false;
        document.getElementById('username').disabled = false;
        document.getElementById('password').disabled = false;
        
        // Reset entire page to initial state (optionally preserving results)
        resetPage(preserveResults);
      }
    }
    
    function downloadFailedItemsCSV(results) {
      // Filter for failed items only
      const failedItems = results.filter(r => !r.status.includes('success'));
      
      if (failedItems.length === 0) {
        alert('No failed items to download.');
        return;
      }
      
      let csvContent = 'WO Number,Barcode,Serials Count,Error Message\n';
      
      failedItems.forEach(item => {
        const woNum = item.woNum || 'N/A';
        const barcode = item.barcode || 'N/A';
        const serials = item.serials || 0;
        const error = (item.error || 'Unknown error').replace(/"/g, '""'); // Escape quotes
        
        csvContent += `"${woNum}","${barcode}","${serials}","${error}"\n`;
      });
      
      // Create download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `failed-items-${new Date().toISOString().slice(0, 10)}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      log(`[EXPORT] Downloaded ${failedItems.length} failed items to CSV\n`);
    }
    
    async function closeAndLogout() {
      log('\n[USER] Closing job and logging out...\n');
      
      // Clear the log for a fresh start
      document.getElementById('log').textContent = '';
      
      // Logout without preserving results (fresh start)
      await logout(false);
      
      log('='.repeat(60) + '\n');
      log('Manufacturing Orchestrator (Queue-Based)\n');
      log('='.repeat(60) + '\n');
      log('Ready for new session. Please login to continue.\n');
    }
    
    async function detectDatabaseName() {
      try {
        const sql = 'SELECT DATABASE() as current_db';
        const rows = await fishbowlQuery(sql);
        
        if (!rows || rows.length === 0) {
          throw new Error('Could not detect database name');
        }
        
        const databaseName = kv(rows[0], 'current_db');
        
        if (!databaseName) {
          throw new Error('Database name is null or empty');
        }
        
        return databaseName;
      } catch (e) {
        log(`[ERROR] Failed to detect database: ${e.message}\n`);
        throw new Error(`Database detection failed: ${e.message}`);
      }
    }
    
    // ============================================================================
    // FISHBOWL API FUNCTIONS
    // ============================================================================
    
    async function fishbowlAPI(endpoint, payload) {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      
      if (!sessionToken) {
        throw new Error('Not logged in. Please login first.');
      }
      
      const response = await fetch(`/api/fishbowl/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serverUrl: serverUrl,
          token: sessionToken,
          payload: payload
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (data.FbiJson?.FbiMsgsRs?.ErrorRs) {
        throw new Error(data.FbiJson.FbiMsgsRs.ErrorRs.statusMessage || 'Fishbowl API error');
      }
      
      return data;
    }
    
    async function fishbowlREST(endpoint, method = 'POST', payload = null) {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      
      if (!sessionToken) {
        throw new Error('Not logged in. Please login first.');
      }
      
      const response = await fetch(`/api/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serverUrl: serverUrl,
          token: sessionToken,
          method: method,
          payload: payload
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      return data;
    }
    
    async function fishbowlQuery(sql) {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      
      if (!sessionToken) {
        throw new Error('Not logged in. Please login first.');
      }
      
      const response = await fetch('/api/data-query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serverUrl: serverUrl,
          token: sessionToken,
          sql: sql
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data) return [];
      return Array.isArray(data) ? data : [data];
    }
    
    async function fishbowlUnsafeQuery(sql) {
      const serverUrl = document.getElementById('serverUrl').value.trim();
      
      if (!sessionToken) {
        throw new Error('Not logged in. Please login first.');
      }
      
      const response = await fetch('/api/unsafe/deprecated/data-query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serverUrl: serverUrl,
          token: sessionToken,
          sql: sql
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data) return [];
      return Array.isArray(data) ? data : [data];
    }
    
    // ============================================================================
    // DATABASE QUEUE TABLE
    // ============================================================================
    
    async function initializeQueueTable(databaseName) {
      try {
        log('[DB] Initializing queue table...\n');
        log(`[DB] Using database: ${databaseName}\n`);
        
        const response = await fetch('/api/mysql/init-queue-table', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: databaseName })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        log(`[OK] Queue table ready in database: ${result.database}\n`);
        log(`[DB] Table has ${result.rowCount || 0} existing row(s)\n`);
        
      } catch (e) {
        log(`[ERROR] Error initializing queue table: ${e.message}\n`);
        alert(`Database Initialization Failed:\n\n${e.message}\n\nPlease contact your system administrator.`);
        throw e;
      }
    }
    
    async function getQueueStats() {
      try {
        const sql = `
          SELECT 
            status,
            COUNT(*) as count,
            COUNT(DISTINCT mo_number) as mo_count
          FROM mo_queue
          GROUP BY status
        `;
        const rows = await fishbowlQuery(sql);
        
        const stats = {
          pending: 0,
          success: 0,
          failed: 0,
          total: 0,
          moCount: 0
        };
        
        rows.forEach(row => {
          const status = (kv(row, 'status') || '').toLowerCase();
          const count = parseInt(kv(row, 'count') || 0);
          
          if (status === 'pending') stats.pending = count;
          else if (status === 'success') stats.success = count;
          else if (status === 'failed') stats.failed = count;
          
          stats.total += count;
        });
        
        const moSQL = "SELECT COUNT(DISTINCT mo_number) as mo_count FROM mo_queue WHERE mo_number IS NOT NULL";
        const moResult = await fishbowlQuery(moSQL);
        stats.moCount = parseInt(kv(moResult[0], 'mo_count') || 0);
        
        return stats;
      } catch (e) {
        log(`[ERROR] Error getting queue stats: ${e.message}\n`);
        return { pending: 0, success: 0, failed: 0, total: 0, moCount: 0 };
      }
    }
    
    // ============================================================================
    // STEP 1: LOCATION GROUP & BOM SELECTION
    // ============================================================================
    
    async function loadLocationGroups() {
      try {
        log('Loading location groups...\n');
        const sql = "SELECT locationgroup.name AS locationgroupnamelistvalue, locationgroup.id AS locgid FROM locationgroup WHERE locationgroup.activeflag = 1 ORDER BY 1";
        const rows = await fishbowlQuery(sql);
        
        if (!rows.length) {
          populateSelect('locationGroupSelect', [], 'No location groups found');
          return log('[WARN] No active location groups found\n');
        }
        
        const opts = rows.map(r => {
          const locgid = kv(r,'locgid');
          const name = kv(r,'locationgroupnamelistvalue');
          return `<option value="${locgid}">${name}</option>`;
        });
        populateSelect('locationGroupSelect', opts, '<img src="images/clipboard.svg" class="icon" alt="Clipboard"> Select a location group');
        log(`[OK] Loaded ${rows.length} location group(s)\n`);
      } catch (e) {
        log(`[ERROR] Error loading location groups: ${e.message}\n`);
        console.error('Full error:', e);
      }
    }
    
    async function onLocationGroupChange() {
      const locGroupId = document.getElementById('locationGroupSelect').value;
      const bomSelect = document.getElementById('bomSelect');
      const btnSelectBOM = document.getElementById('btnSelectBOM');
      
      if (!locGroupId) {
        bomSelect.disabled = btnSelectBOM.disabled = true;
        bomSelect.innerHTML = '<option value=""><img src="images/clipboard.svg" class="icon" alt="Clipboard"> First select a location group</option>';
        return;
      }
      
      state.locationGroup = locGroupId;
      bomSelect.disabled = false;
      await loadBOMs(locGroupId);
    }
    
    async function loadBOMs(locGroupId) {
      try {
        log(`Loading BOMs for location group ${locGroupId}...\n`);
        const sql = `SELECT bom.id AS bomid, bom.num, CONCAT(bom.num,' - ',bom.description) AS bom_list_value, locationgroup.id AS locgid, location.id AS locid, CONCAT(locationgroup.name,'-',location.name) AS location_list_value FROM bom JOIN bomitem ON bomitem.bomid = bom.id AND bomitem.typeid = 10 LEFT JOIN defaultlocation df ON df.partId = bomitem.partid AND df.locationGroupId = ${locGroupId} LEFT JOIN location ON location.id = df.locationid LEFT JOIN locationgroup ON locationgroup.id = location.locationgroupid WHERE bom.activeflag = 1 GROUP BY bom.id, bom.num, bom.description, locationgroup.id, location.id, locationgroup.name, location.name ORDER BY bom.num`;
        const rows = await fishbowlQuery(sql);
        
        if (!rows.length) {
          populateSelect('bomSelect', [], 'No BOMs found');
          return log('[WARN] No active BOMs found\n');
        }
        
        window.bomData = new Map();
        const opts = rows.map(r => {
          const num = kv(r, 'num');
          window.bomData.set(num, { id: kv(r, 'bomid'), defaultLocation: kv(r, 'location_list_value') });
          return `<option value="${num}">${kv(r, 'bom_list_value') || num}</option>`;
        });
        
        populateSelect('bomSelect', opts, '<img src="images/clipboard.svg" class="icon" alt="Clipboard"> Select a BOM');
        document.getElementById('btnSelectBOM').disabled = false;
        log(`[OK] Loaded ${rows.length} BOM(s)\n`);
      } catch (e) {
        log(`[ERROR] Error loading BOMs: ${e.message}\n`);
      }
    }
    
    function selectBOM() {
      const locGroupSelect = document.getElementById('locationGroupSelect');
      const bomSelect = document.getElementById('bomSelect');
      const locGroupId = locGroupSelect.value;
      const bomNum = bomSelect.value;
      
      if (!locGroupId) return alert('Please select a location group');
      if (!bomNum) return alert('Please select a BOM');
      
      state.bom = bomNum;
      state.bomId = window.bomData?.get(bomNum)?.id || null;
      state.locationGroup = locGroupId;
      state.bomDefaultLocation = window.bomData?.get(bomNum)?.defaultLocation || null;
      
      document.getElementById('selectedLocationGroup').textContent = locGroupSelect.options[locGroupSelect.selectedIndex].text;
      document.getElementById('selectedBOM').textContent = bomSelect.options[bomSelect.selectedIndex].text;
      document.getElementById('selectedDefaultLocation').textContent = state.bomDefaultLocation || 'None configured';
      document.getElementById('bomInfo').style.display = 'block';
      
      log(`\n[OK] Configuration Selected:\n   Location Group: ${locGroupSelect.options[locGroupSelect.selectedIndex].text}\n   BOM: ${bomSelect.options[bomSelect.selectedIndex].text} (ID: ${state.bomId})\n   Default FG Location: ${state.bomDefaultLocation || 'None'}\n`);
      enableStep('1_5'); // Enable operation type selection
    }

    // ============================================================================
    // STEP 1.5: OPERATION TYPE SELECTION (BUILD vs DISASSEMBLE)
    // ============================================================================

    function selectOperationType(type) {
      state.operationType = type;

      // Update panel styles to show selection
      if (type === 'build') {
        document.getElementById('panelBuild').style.border = '3px solid #5cb85c';
        document.getElementById('panelDisassemble').style.border = '1px solid #ddd';
        log('[OK] BUILD operation selected\n');

        // Hide Step 2B (disassembly), show Step 2 (BUILD/CSV)
        document.getElementById('step2b').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        enableStep(2);
      } else if (type === 'disassemble') {
        document.getElementById('panelDisassemble').style.border = '3px solid #5bc0de';
        document.getElementById('panelBuild').style.border = '1px solid #ddd';
        log('[OK] DISASSEMBLE operation selected\n');

        // Hide Step 2 (BUILD/CSV), show Step 2B (disassembly)
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step2b').style.display = 'block';
        enableStep('2b');

        // Load finished goods for disassembly
        loadFinishedGoods();
      }
    }

    // ============================================================================
    // STEP 2: LOAD CSV
    // ============================================================================
    
    async function loadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) return;

      try {
        log('Loading CSV file...\n');
        const text = await file.text();
        const lines = text.replace(/^\uFEFF/, '').replace(/\r/g, '').split('\n').filter(l => l.trim());
        const parseRow = (line) => line.split(',').map(cell => cell.replace(/^"(.*)"$/, '$1').trim());

        state.csvData = { filename: file.name, rows: lines.map(parseRow), text };

        document.getElementById('csvFileName').textContent = file.name;
        document.getElementById('csvRowCount').textContent = lines.length;
        document.getElementById('csvInfo').style.display = 'block';

        log(`[OK] CSV Loaded: ${file.name}\n   Rows: ${lines.length}\n   Columns: ${state.csvData.rows[0].length}\n`);
        enableStep(3);
        showMappingInterface();
        await loadLocations();
        await loadRawGoods();
      } catch (e) {
        log(`[ERROR] Error loading CSV: ${e.message}\n`);
        alert(`Error: ${e.message}`);
      }
    }

    // ============================================================================
    // STEP 2B: SELECT FINISHED GOODS FOR DISASSEMBLY
    // ============================================================================

    async function loadFinishedGoods() {
      try {
        log('[DISASSEMBLY] Loading finished goods on hand...\n');

        const response = await fetch('/api/get-finished-goods-on-hand', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            database: sessionCredentials.database,
            serverUrl: document.getElementById('serverUrl').value,
            token: sessionToken,
            bomNum: state.bom,
            bomId: state.bomId
          })
        });

        if (!response.ok) {
          throw new Error(`Failed to load finished goods: ${response.statusText}`);
        }

        const data = await response.json();
        state.finishedGoods = data.finishedGoods || data || [];
        state.selectedFinishedGoods = [];

        log(`[OK] Found ${state.finishedGoods.length} finished goods on hand\n`);

        // Populate the available FG list
        renderAvailableFGList();

        // Load return locations
        await loadReturnLocations();

        // Update count
        updateFGCounts();
      } catch (e) {
        log(`[ERROR] Error loading finished goods: ${e.message}\n`);
        alert(`Error loading finished goods: ${e.message}`);
      }
    }

    async function loadReturnLocations() {
      try {
        const locGroupId = state.locationGroup;
        const response = await fetch('/api/get-locations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: document.getElementById('serverUrl').value,
            token: sessionToken,
            locationGroupId: locGroupId
          })
        });

        if (!response.ok) {
          throw new Error(`Failed to load locations: ${response.statusText}`);
        }

        const data = await response.json();
        const locations = data.locations || [];

        const select = document.getElementById('fgReturnLocation');
        select.innerHTML = '<option value="">Select return location for raw goods</option>' +
          locations.map(loc => `<option value="${loc.location_id}">${loc.list_value}</option>`).join('');

        log(`[OK] Loaded ${locations.length} return locations\n`);
      } catch (e) {
        log(`[ERROR] Error loading return locations: ${e.message}\n`);
      }
    }

    function renderAvailableFGList() {
      const container = document.getElementById('availableFGList');
      const searchTerm = (document.getElementById('fgSearchBox').value || '').toLowerCase();

      const filtered = state.finishedGoods.filter(fg => {
        const searchText = `${fg.barcode} ${fg.fg_part_num} ${fg.fg_description} ${fg.full_location}`.toLowerCase();
        return searchText.includes(searchTerm);
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No finished goods found</div>';
        return;
      }

      container.innerHTML = filtered.map(fg => {
        const isSelected = state.selectedFinishedGoods.some(sel => sel.barcode === fg.barcode);
        if (isSelected) return ''; // Don't show in available list if already selected

        return `
          <div class="fg-item" data-barcode="${fg.barcode}" style="padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;">
            <input type="checkbox" class="fg-checkbox" data-barcode="${fg.barcode}" style="margin-right: 8px;">
            <strong>${fg.barcode}</strong><br>
            <small>${fg.fg_part_num} - ${fg.fg_description}</small><br>
            <small class="text-muted">Location: ${fg.full_location}</small><br>
            <small class="text-info">Built: ${new Date(fg.build_date).toLocaleString()}</small>
          </div>
        `;
      }).filter(html => html).join('');

      // Add click handlers
      container.querySelectorAll('.fg-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return; // Let checkbox handle itself
          const checkbox = item.querySelector('.fg-checkbox');
          checkbox.checked = !checkbox.checked;
        });
      });

      updateFGCounts();
    }

    function renderSelectedFGList() {
      const container = document.getElementById('selectedFGList');

      if (state.selectedFinishedGoods.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No finished goods selected</div>';
        document.getElementById('btnConfirmDisassembly').disabled = true;
        return;
      }

      container.innerHTML = state.selectedFinishedGoods.map(fg => `
        <div class="fg-item" data-barcode="${fg.barcode}" style="padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;">
          <input type="checkbox" class="fg-selected-checkbox" data-barcode="${fg.barcode}" style="margin-right: 8px;">
          <strong>${fg.barcode}</strong><br>
          <small>${fg.fg_part_num} - ${fg.fg_description}</small><br>
          <small class="text-muted">Location: ${fg.full_location}</small><br>
          <small class="text-info">Built: ${new Date(fg.build_date).toLocaleString()}</small>
        </div>
      `).join('');

      // Add click handlers
      container.querySelectorAll('.fg-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          const checkbox = item.querySelector('.fg-selected-checkbox');
          checkbox.checked = !checkbox.checked;
        });
      });

      // Enable confirm button if location is selected
      const locationSelected = document.getElementById('fgReturnLocation').value;
      document.getElementById('btnConfirmDisassembly').disabled = !locationSelected;

      updateFGCounts();
    }

    function updateFGCounts() {
      const availableCount = state.finishedGoods.length - state.selectedFinishedGoods.length;
      document.getElementById('availableFGCount').textContent = availableCount;
      document.getElementById('selectedFGCount').textContent = state.selectedFinishedGoods.length;
    }

    function addSelectedFG() {
      const checkboxes = document.querySelectorAll('#availableFGList .fg-checkbox:checked');
      const barcodesToAdd = Array.from(checkboxes).map(cb => cb.getAttribute('data-barcode'));

      barcodesToAdd.forEach(barcode => {
        const fg = state.finishedGoods.find(f => f.barcode === barcode);
        if (fg && !state.selectedFinishedGoods.some(sel => sel.barcode === barcode)) {
          state.selectedFinishedGoods.push(fg);
        }
      });

      renderAvailableFGList();
      renderSelectedFGList();
    }

    function addAllFG() {
      state.selectedFinishedGoods = [...state.finishedGoods];
      renderAvailableFGList();
      renderSelectedFGList();
    }

    function removeSelectedFG() {
      const checkboxes = document.querySelectorAll('#selectedFGList .fg-selected-checkbox:checked');
      const barcodesToRemove = Array.from(checkboxes).map(cb => cb.getAttribute('data-barcode'));

      state.selectedFinishedGoods = state.selectedFinishedGoods.filter(
        fg => !barcodesToRemove.includes(fg.barcode)
      );

      renderAvailableFGList();
      renderSelectedFGList();
    }

    function removeAllFG() {
      state.selectedFinishedGoods = [];
      renderAvailableFGList();
      renderSelectedFGList();
    }

    async function confirmDisassembly() {
      const returnLocation = document.getElementById('fgReturnLocation').value;

      if (!returnLocation) {
        return alert('Please select a return location for raw goods');
      }

      if (state.selectedFinishedGoods.length === 0) {
        return alert('Please select at least one finished good to disassemble');
      }

      try {
        log(`\n[DISASSEMBLY] Queuing ${state.selectedFinishedGoods.length} finished goods for disassembly...\n`);

        // Queue each FG for disassembly
        for (const fg of state.selectedFinishedGoods) {
          // Query the original WO structure to get exact parts, quantities, and tracking
          log(`[DISASSEMBLY] Querying original WO structure for ${fg.wo_number}...\n`);

          try {
            const woStructureResponse = await fetch('/api/fishbowl/workorder-structure', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                serverUrl: document.getElementById('serverUrl').value,
                token: sessionToken,
                woNumber: fg.wo_number
              })
            });

            if (!woStructureResponse.ok) {
              const errorText = await woStructureResponse.text();
              log(`[ERROR] Failed to query WO structure: ${woStructureResponse.status} ${errorText}\n`);
              throw new Error(`Failed to query WO structure for ${fg.wo_number}: ${woStructureResponse.statusText}`);
            }

            const woStructure = await woStructureResponse.json();
            log(`[OK] Retrieved ${woStructure.length} items from original WO ${fg.wo_number}\n`);

            const queueData = {
              serverUrl: document.getElementById('serverUrl').value,
              token: sessionToken,
              database: sessionCredentials.database,
              barcode: fg.barcode,
              serialNumbers: fg.serial_numbers, // Legacy field, kept for compatibility
              fgLocationId: returnLocation,
              rawGoodsPartId: null, // Not applicable for disassembly
              fgPartId: fg.fg_part_id,
              bomNum: state.bom,
              bomId: state.bomId,
              locationGroupId: state.locationGroup,
              operationType: 'disassemble',
              originalWoStructure: JSON.stringify(woStructure) // Store complete WO structure
            };

            const response = await fetch('/api/queue-work-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(queueData)
            });

            if (!response.ok) {
              const errorText = await response.text();
              log(`[ERROR] Failed to queue: ${response.status} ${errorText}\n`);
              throw new Error(`Failed to queue ${fg.barcode}: ${response.statusText}`);
            }

            log(`[OK] Queued: ${fg.barcode}\n`);
          } catch (error) {
            log(`[ERROR] Error processing ${fg.barcode}: ${error.message}\n`);
            throw error; // Re-throw to be caught by outer try-catch
          }
        }

        log(`[OK] Successfully queued ${state.selectedFinishedGoods.length} finished goods\n`);
        alert(`Successfully queued ${state.selectedFinishedGoods.length} finished goods for disassembly`);

        // Disable step 2b to prevent re-queueing
        const step2b = document.getElementById('step2b');
        step2b.classList.add('disabled');
        step2b.style.opacity = '0.5';
        step2b.style.pointerEvents = 'none';
        $('#collapseStep2b').collapse('hide');

        // Disable the button
        document.getElementById('btnConfirmDisassembly').disabled = true;

        // Enable Step 4 to process the queue
        enableStep(4);
        await updateQueueStats();
      } catch (e) {
        log(`[ERROR] Error queuing disassembly: ${e.message}\n`);
        alert(`Error queuing disassembly: ${e.message}`);
      }
    }

    // ============================================================================
    // STEP 3: MAP COLUMNS & VALIDATE
    // ============================================================================
    
    function showMappingInterface() {
      const firstRow = state.csvData.rows[0];
      const previewRows = state.csvData.rows.slice(0, 3);
      
      let tableHtml = '<table class="csv-preview-table table table-bordered table-condensed">';
      previewRows.forEach((row, idx) => {
        const tag = idx === 0 ? 'th' : 'td';
        tableHtml += '<tr>' + row.map(cell => `<${tag}>${cell || '<em>(empty)</em>'}</${tag}>`).join('') + '</tr>';
      });
      document.getElementById('csvPreview').innerHTML = tableHtml + '</table>';
      
      const opts = firstRow.map((col, idx) => `<option value="${idx}">${idx + 1}: ${col || `Column ${idx + 1}`}</option>`).join('');
      document.getElementById('serialColumn').innerHTML = document.getElementById('barcodeColumn').innerHTML = opts;
      
      const lowerHeaders = firstRow.map(h => (h || '').toLowerCase());
      const serialIdx = lowerHeaders.findIndex(h => h.includes('serial') || h.includes('sn'));
      const barcodeIdx = lowerHeaders.findIndex(h => h.includes('barcode') || h.includes('bc'));
      
      document.getElementById('serialColumn').value = serialIdx !== -1 ? serialIdx : 0;
      document.getElementById('barcodeColumn').value = barcodeIdx !== -1 ? barcodeIdx : Math.min(1, firstRow.length - 1);
      log('CSV columns detected automatically\n');
    }
    
    async function loadLocations() {
      try {
        log('Loading locations...\n');
        const select = document.getElementById('fgLocation');

        const sql = `SELECT DISTINCT CONCAT(locationgroup.name,'-',location.name) AS location_list FROM location JOIN locationgroup ON locationgroup.id = location.locationgroupid WHERE location.activeflag = 1 AND locationgroup.activeflag = 1 AND locationgroup.id = ${state.locationGroup} ORDER BY locationgroup.name, location.name`;
        const rows = await fishbowlQuery(sql);

        if (!rows.length) {
          select.innerHTML = '<option value="">No locations found</option>';
          return log('[WARN] No active locations found\n');
        }

        const opts = rows.map(r => {
          const loc = kv(r, 'location_list');
          return `<option value="${loc}">${loc}</option>`;
        });
        populateSelect('fgLocation', opts, '<img src="images/clipboard.svg" class="icon" alt="Clipboard"> Select a location');

        if (state.bomDefaultLocation) {
          select.value = state.bomDefaultLocation;
          log(`[OK] Loaded ${rows.length} location(s) from location group\n[OK] Default location pre-selected: ${state.bomDefaultLocation}\n`);
        } else {
          log(`[OK] Loaded ${rows.length} location(s) from location group\n[WARN] No default location configured for this BOM\n`);
        }
      } catch (e) {
        log(`[ERROR] Error loading locations: ${e.message}\n`);
      }
    }

    async function loadRawGoods() {
      try {
        log('Loading raw goods with serial tracking...\n');
        const select = document.getElementById('rawGoodPart');
        const serverUrl = document.getElementById('serverUrl').value.trim();

        const response = await fetch('/api/get-raw-goods', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: serverUrl,
            token: sessionToken,
            bomNum: state.bom
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const rows = await response.json();

        if (!rows || !rows.length) {
          select.innerHTML = '<option value="">No tracked raw goods found</option>';
          log('[ERROR] No raw goods with serial tracking found for this BOM\n');
          alert('ERROR: No raw goods with serial tracking (Part Tracking Type = Serial Number) found for this BOM.\n\nPlease verify the BOM configuration.');
          return;
        }

        const opts = rows.map(r => {
          const partId = kv(r, 'part_id');
          const listValue = kv(r, 'list_values');
          return `<option value="${partId}">${listValue}</option>`;
        });
        populateSelect('rawGoodPart', opts, '<img src="images/clipboard.svg" class="icon" alt="Clipboard"> Select raw good part');

        log(`[OK] Loaded ${rows.length} tracked raw good(s)\n`);
      } catch (e) {
        log(`[ERROR] Error loading raw goods: ${e.message}\n`);
        document.getElementById('rawGoodPart').innerHTML = '<option value="">Error loading raw goods</option>';
      }
    }
    
    async function validateAndPrepare() {
      const fgLocation = document.getElementById('fgLocation').value;
      if (!fgLocation) return alert('Please select a finished good location');

      const rawGoodPartId = document.getElementById('rawGoodPart').value;
      if (!rawGoodPartId) return alert('Please select a raw good part for serial number allocation');

      const hasHeaders = document.getElementById('hasHeaders').checked;
      const serialIdx = parseInt(document.getElementById('serialColumn').value, 10);
      const barcodeIdx = parseInt(document.getElementById('barcodeColumn').value, 10);

      if (serialIdx === barcodeIdx) return alert('Serial and Barcode columns cannot be the same');
      
      log(`\n${'='.repeat(60)}\nVALIDATING CSV DATA\n${'='.repeat(60)}\n`);
      
      const dataRows = [];
      for (let i = hasHeaders ? 1 : 0; i < state.csvData.rows.length; i++) {
        const row = state.csvData.rows[i];
        const serial = (row[serialIdx] || '').trim();
        const barcode = (row[barcodeIdx] || '').trim();
        if (serial && barcode) dataRows.push({ serial, barcode });
      }
      
      if (!dataRows.length) return alert('No valid data rows found');
      
      const chunks = new Map();
      dataRows.forEach(row => {
        if (!chunks.has(row.barcode)) chunks.set(row.barcode, []);
        chunks.get(row.barcode).push(row.serial);
      });
      
      state.mapping = { hasHeaders, serialIdx, barcodeIdx };
      state.chunks = chunks;
      
      log(`Parsed ${dataRows.length} serial(s) across ${chunks.size} barcode(s)\n`);
      
      const allSerials = [], allBarcodes = [];
      for (const [barcode, serials] of state.chunks) {
        allSerials.push(...serials);
        allBarcodes.push(barcode);
      }
      const uniqueSerials = [...new Set(allSerials)];
      const uniqueBarcodes = [...new Set(allBarcodes)];
      
      log(`Checking ${uniqueSerials.length} unique serial(s) in Fishbowl...\n`);
      
      const serialsInClause = uniqueSerials.map(s => `'${s.replace(/'/g, "''")}'`).join(',');
      const findSerialsSQL = `SELECT DISTINCT tisn.serialnum AS serial FROM serialnum tisn JOIN serial s ON s.id = tisn.serialid JOIN tag t ON t.id = s.tagid WHERE tisn.parttrackingid = 4 AND tisn.serialnum IN (${serialsInClause})`;
      
      let foundSerials = [];
      try {
        foundSerials = await fishbowlQuery(findSerialsSQL);
        log(`[OK] Found ${foundSerials.length} serial(s) in Fishbowl\n`);
      } catch (e) {
        log(`[ERROR] Error querying serials: ${e.message}\n`);
        return alert('Error validating serials. Check the log for details.');
      }
      
      log(`Checking ${uniqueBarcodes.length} unique barcode(s) in Fishbowl...\n`);
      const barcodesInClause = uniqueBarcodes.map(b => `'${b.replace(/'/g, "''")}'`).join(',');
      const findBarcodesSQL = `SELECT DISTINCT tisn.serialnum AS barcode FROM serialnum tisn JOIN serial s ON s.id = tisn.serialid JOIN tag t ON t.id = s.tagid WHERE tisn.parttrackingid = 5 AND tisn.serialnum IN (${barcodesInClause})`;
      
      let existingBarcodes = [];
      try {
        existingBarcodes = await fishbowlQuery(findBarcodesSQL);
        log(existingBarcodes.length > 0 ? `[WARN] Found ${existingBarcodes.length} barcode(s) that already exist in Fishbowl\n` : '[OK] No barcode conflicts found\n');
      } catch (e) {
        log(`[ERROR] Error querying barcodes: ${e.message}\n`);
        return alert('Error validating barcodes. Check the log for details.');
      }
      
      const foundSerialSet = new Set(foundSerials.map(r => String(kv(r, 'serial')).trim()));
      const existingBarcodeSet = new Set(existingBarcodes.map(r => String(kv(r, 'barcode')).trim()));
      const validChunks = new Map();
      const excludedDueToBarcodeExists = [], excludedDueToMissingSerials = [];
      
      for (const [barcode, serials] of state.chunks) {
        if (existingBarcodeSet.has(String(barcode).trim())) {
          excludedDueToBarcodeExists.push({ barcode, serials, reason: 'Barcode already exists in Fishbowl' });
          log(`[WARN] Excluding barcode ${barcode}: Already exists in Fishbowl\n`);
        } else {
          const missingSerials = serials.filter(s => !foundSerialSet.has(String(s).trim()));
          if (missingSerials.length > 0) {
            excludedDueToMissingSerials.push({ barcode, serials, missingSerials, reason: `${missingSerials.length} serial(s) not found in Fishbowl` });
            log(`[WARN] Excluding barcode ${barcode}: ${missingSerials.length} serial(s) not found\n   Missing: ${missingSerials.join(', ')}\n`);
          } else {
            validChunks.set(barcode, serials);
          }
        }
      }
      
      const excludedChunks = [...excludedDueToBarcodeExists, ...excludedDueToMissingSerials];
      
      log(`\n${'='.repeat(60)}\nVALIDATION SUMMARY\n${'='.repeat(60)}\nTotal Barcodes: ${state.chunks.size}\n[OK] Valid: ${validChunks.size}\n[ERROR] Excluded: ${excludedChunks.length}\n`);
      
      state.validationResults = {
        valid: validChunks,
        excludedBarcodeExists: excludedDueToBarcodeExists,
        excludedMissingSerials: excludedDueToMissingSerials,
        fgLocation: fgLocation,
        rawGoodPartId: rawGoodPartId
      };
      
      displayValidationResults();
    }
    
    function displayValidationResults() {
      const results = state.validationResults;
      const validCount = results.valid.size;
      const excludedCount = results.excludedBarcodeExists.length + results.excludedMissingSerials.length;
      
      let summaryHtml = `
        <strong>Validation Complete:</strong><br>
        <img src="images/check.svg" class="icon" alt="Success"> Valid Barcodes: <strong>${validCount}</strong><br>
        <img src="images/x.svg" class="icon" alt="Error"> Excluded Barcodes: <strong>${excludedCount}</strong><br>
      `;
      
      if (validCount > 0) {
        let totalSerials = 0;
        for (const serials of results.valid.values()) totalSerials += serials.length;
        summaryHtml += `Total Serials (Valid): <strong>${totalSerials}</strong><br>`;
        summaryHtml += `Finished Good Location: <strong>${results.fgLocation}</strong><br>`;
      }
      
      document.getElementById('validationSummary').innerHTML = summaryHtml;
      
      if (excludedCount > 0) {
        let issuesHtml = '<strong><img src="images/warning.svg" class="icon" alt="Warning"> Issues Found:</strong><br><br>';
        
        if (results.excludedBarcodeExists.length > 0) {
          issuesHtml += `<strong>Barcode Already Exists (${results.excludedBarcodeExists.length}):</strong><br>`;
          results.excludedBarcodeExists.forEach(item => {
            issuesHtml += `<img src="images/package.svg" class="icon" alt="Package"> ${item.barcode}<br>`;
          });
          issuesHtml += '<br>';
        }
        
        if (results.excludedMissingSerials.length > 0) {
          issuesHtml += `<strong>Missing Serial Numbers (${results.excludedMissingSerials.length}):</strong><br>`;
          results.excludedMissingSerials.forEach(item => {
            issuesHtml += `<img src="images/package.svg" class="icon" alt="Package"> ${item.barcode}: ${item.missingSerials.length} missing (${item.missingSerials.slice(0, 3).join(', ')}${item.missingSerials.length > 3 ? '...' : ''})<br>`;
          });
        }
        
        issuesHtml += '<br><button id="btnDownloadExcluded" class="btn btn-warning btn-sm"><img src="images/save.svg" class="icon" alt="Download"> Download Excluded Items (CSV)</button>';
        
        document.getElementById('validationIssues').innerHTML = issuesHtml;
        document.getElementById('validationIssues').style.display = 'block';
        
        // Wire up the download button
        document.getElementById('btnDownloadExcluded').addEventListener('click', downloadExcludedCSV);
      } else {
        document.getElementById('validationIssues').style.display = 'none';
      }
      
      if (validCount > 0) {
        document.getElementById('btnSaveToQueue').style.display = 'block';
      } else {
        document.getElementById('btnSaveToQueue').style.display = 'none';
        alert('⚠ No valid items to process!\n\nAll barcodes were excluded due to validation errors.\n\nPlease fix the issues and try again.');
      }
      
      document.getElementById('validationResults').style.display = 'block';
    }
    
    function downloadExcludedCSV() {
      const results = state.validationResults;

      let csvContent = 'Barcode,SerialNumber,IssueType,Details\n';

      // Add barcodes that already exist - ALL serials in the chunk get this error
      results.excludedBarcodeExists.forEach(item => {
        const barcode = item.barcode;
        const serials = item.serials;

        serials.forEach(serial => {
          csvContent += `"${barcode}","${serial}","Barcode Already Exists","Barcode ${barcode} already exists in Fishbowl"\n`;
        });
      });

      // Add barcodes with missing serials - show each serial with its specific status
      results.excludedMissingSerials.forEach(item => {
        const barcode = item.barcode;
        const allSerials = item.serials;
        const missingSerials = new Set(item.missingSerials);

        allSerials.forEach(serial => {
          if (missingSerials.has(serial)) {
            // This serial is missing from Fishbowl
            csvContent += `"${barcode}","${serial}","Missing Serial","Serial ${serial} not found in Fishbowl"\n`;
          } else {
            // This serial exists but chunk is excluded due to other missing serials
            csvContent += `"${barcode}","${serial}","Excluded Due to Other Missing Serials","Valid serial but chunk excluded"\n`;
          }
        });
      });

      // Create download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', `excluded-items-${new Date().toISOString().slice(0, 10)}.csv`);
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      log('[EXPORT] Downloaded excluded items CSV with detailed serial-level information\n');
    }
    
    async function saveToQueue() {
      const results = state.validationResults;
      
      if (!results || results.valid.size === 0) {
        return alert('No valid items to save');
      }
      
      try {
        log(`\n${'='.repeat(60)}\nSAVING TO QUEUE\n${'='.repeat(60)}\n`);
        
        // Get config to get database name
        const configResponse = await fetch('/api/load-config');
        const config = await configResponse.json();
        
        if (!config.database) {
          throw new Error('Database not configured');
        }
        
        // Check for existing PENDING records with these barcodes
        log(`Checking for existing PENDING records...\n`);
        
        const barcodes = Array.from(results.valid.keys());
        
        const checkResponse = await fetch('/api/mysql/delete-pending-barcodes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            database: config.database,
            barcodes: barcodes
          })
        });
        
        if (!checkResponse.ok) {
          throw new Error('Failed to check for existing records');
        }
        
        const checkResult = await checkResponse.json();
        
        if (checkResult.deletedCount > 0) {
          log(`[CLEANUP] Found and deleted ${checkResult.deletedCount} existing PENDING record(s)\n`);
          log(`[INFO] Barcodes cleaned up: ${checkResult.barcodes.slice(0, 5).join(', ')}${checkResult.barcodes.length > 5 ? '...' : ''}\n`);
          log(`[REASON] Removing stale records from previous attempts\n`);
        } else {
          log(`[OK] No existing PENDING records found - starting fresh\n`);
        }
        
        // Now insert the new records
        log(`Saving ${results.valid.size} barcode(s) to queue...\n`);
        
        const values = [];
        for (const [barcode, serials] of results.valid) {
          const serialsJson = JSON.stringify(serials);
          values.push(`(NOW(), NULL, '${barcode.replace(/'/g, "''")}', '${serialsJson.replace(/'/g, "''")}', '${results.fgLocation.replace(/'/g, "''")}', ${results.rawGoodPartId}, '${state.bom.replace(/'/g, "''")}', ${state.bomId}, ${state.locationGroup}, 'Pending', NULL, NULL, 0)`);
        }

        const insertSQL = `
          INSERT INTO mo_queue
          (datetime, mo_number, barcode, serial_numbers, fg_location, raw_goods_part_id, bom_num, bom_id, location_group_id, status, wo_number, error_message, retry_count)
          VALUES ${values.join(', ')}
        `;
        
        await fishbowlUnsafeQuery(insertSQL);
        
        log(`[OK] Saved ${results.valid.size} item(s) to queue\n`);
        
        let alertMessage = `✓ Successfully saved ${results.valid.size} item(s) to queue!`;
        
        if (checkResult.deletedCount > 0) {
          alertMessage += `\n\n⚠ Note: ${checkResult.deletedCount} previous PENDING record(s) were replaced with your new data.`;
        }
        
        alertMessage += `\n\nProceed to Step 4 to process.`;
        
        alert(alertMessage);
        
        enableStep(4);
        await updateQueueStats();
        
      } catch (e) {
        log(`[ERROR] Error saving to queue: ${e.message}\n`);
        alert(`Error saving to queue: ${e.message}`);
      }
    }
    
    // ============================================================================
    // STEP 4: PROCESS QUEUE
    // ============================================================================
    
    async function updateQueueStats() {
      try {
        const stats = await getQueueStats();
        
        const statsHtml = `
          <strong class="text-warning">${stats.pending > 0 ? 'Pending' : 'Idle'}</strong><br>
          WO's to Process: <strong>${stats.pending}</strong>
        `;
        
        document.getElementById('queueStatsContent').innerHTML = statsHtml;
      } catch (e) {
        document.getElementById('queueStatsContent').innerHTML = `<span class="text-danger">Error loading stats: ${e.message}</span>`;
      }
    }
    
    async function processQueue() {
      try {
        log(`\n${'='.repeat(60)}\nSTARTING QUEUE PROCESSING\n${'='.repeat(60)}\n`);

        const configResponse = await fetch('/api/load-config');
        const config = await configResponse.json();

        if (!config.database) {
          throw new Error('Database not configured. Please login first.');
        }

        // Check if we're resuming a job (get BOM/location from queue) or starting fresh
        let bomNum, bomId, locationGroupId;

        if (state.bom && state.bomId && state.locationGroup) {
          // Starting a new job
          bomNum = state.bom;
          bomId = state.bomId;
          locationGroupId = state.locationGroup;
          log(`[NEW JOB] Using BOM: ${bomNum}, Location Group: ${locationGroupId}\n`);
        } else {
          // Resuming an interrupted job - get BOM/location from first pending item
          log(`[RESUME] Getting BOM and location group from pending items...\n`);

          const resumeSQL = 'SELECT bom_num, bom_id, location_group_id FROM mo_queue WHERE status = "Pending" LIMIT 1';
          const resumeData = await fishbowlQuery(resumeSQL);

          if (!resumeData || resumeData.length === 0) {
            throw new Error('No pending items found in queue');
          }

          bomNum = kv(resumeData[0], 'bom_num');
          bomId = kv(resumeData[0], 'bom_id');
          locationGroupId = kv(resumeData[0], 'location_group_id');

          log(`[RESUME] Retrieved from queue - BOM: ${bomNum}, Location Group: ${locationGroupId}\n`);
        }

        log(`[SERVER] Starting server-side processing...\n`);
        
        // Hide queue stats during processing (will show at completion)
        document.getElementById('queueStats').style.display = 'none';
        
        const startResponse = await fetch('/api/start-queue-processing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: document.getElementById('serverUrl').value.trim(),
            token: sessionToken,
            database: config.database,
            bom: bomNum,
            bomId: bomId,
            locationGroup: locationGroupId
          })
        });
        
        if (!startResponse.ok) {
          const errorData = await startResponse.json();
          throw new Error(errorData.error || 'Failed to start processing');
        }
        
        const startData = await startResponse.json();
        log(`[OK] Server accepted job: ${startData.jobId}\n`);
        log(`[INFO] Processing in background - you can close this browser\n`);
        
        // === IMMEDIATELY SHOW "JOB RUNNING" UI STATE ===
        
        // Show banner
        const bannerEl = document.getElementById('reconnectBanner');
        bannerEl.innerHTML = `
          <strong><img src="images/rocket.svg" class="icon" alt="Launch"> Processing Job Started</strong><br>
          Job is running on the server. You can safely close this browser - progress is saved to the database.
        `;
        bannerEl.style.background = '#fff3cd';
        bannerEl.style.borderLeft = '4px solid #ffc107';
        bannerEl.style.display = 'block';
        
        // Grey out and disable login panel
        const configPanel = document.querySelector('.config-panel');
        configPanel.style.opacity = '0.6';
        configPanel.style.pointerEvents = 'none';
        
        // Disable login inputs
        document.getElementById('serverUrl').disabled = true;
        document.getElementById('username').disabled = true;
        document.getElementById('password').disabled = true;
        document.getElementById('btnLogin').disabled = true;
        document.getElementById('btnLogout').disabled = true;
        
        // Grey out and disable configuration steps
        document.getElementById('step1').style.opacity = '0.6';
        document.getElementById('step1').style.pointerEvents = 'none';
        document.getElementById('step2').style.opacity = '0.6';
        document.getElementById('step2').style.pointerEvents = 'none';
        document.getElementById('step3').style.opacity = '0.6';
        document.getElementById('step3').style.pointerEvents = 'none';
        
        // Disable the Process Queue button
        document.getElementById('btnProcess').disabled = true;
        document.getElementById('btnProcess').textContent = 'Job Already Running';
        document.getElementById('btnProcess').classList.remove('btn-warning');
        document.getElementById('btnProcess').classList.add('btn-default');
        
        // Collapse other steps
        $('#collapseStep1').collapse('hide');
        $('#collapseStep2').collapse('hide');
        $('#collapseStep3').collapse('hide');
        
        // === END UI STATE CHANGES ===
        
        document.getElementById('processResults').style.display = 'block';
        document.getElementById('processResultContent').innerHTML = `
          <div class="alert alert-info">
            <h4><img src="images/rocket.svg" class="icon" alt="Launch"> Processing in Background...</h4>
            <p><strong>Status:</strong> <span id="statusText">Starting...</span></p>
            <p><strong>Progress:</strong> <span id="progressText">0 / 0</span></p>
            <p><strong>Time Elapsed:</strong> <span id="timeElapsed">0s</span></p>
            <p><strong>Estimated Time Remaining:</strong> <span id="timeRemaining">Calculating...</span></p>
            <p><strong>Current MO:</strong> <span id="currentMO">-</span></p>
            <p><strong>Current WO:</strong> <span id="currentWO">-</span></p>
            <div class="progress" style="margin-top:10px;">
              <div id="progressBar" class="progress-bar progress-bar-striped active" style="width: 0%">
                <span id="progressPercent">0%</span>
              </div>
            </div>
            <div style="margin-top:15px;">
              <button id="btnStopJob" class="btn btn-warning btn-sm"><img src="images/x.svg" class="icon" alt="Stop"> Stop Job</button>
            </div>
            <p style="margin-top:10px;"><small><img src="images/lightbulb.svg" class="icon" alt="Tip"> This page can be closed - processing continues on server</small></p>
          </div>
          <div id="resultsContainer"></div>`;

        // Wire up stop button
        document.getElementById('btnStopJob').addEventListener('click', stopJob);
        
        pollQueueStatus();
        
      } catch (e) {
        log(`[ERROR] Failed to start processing: ${e.message}\n`);
        alert(`Error: ${e.message}`);
      }
    }
    
    async function stopJob() {
      try {
        log('[STOP] Requesting job stop...\n');

        const response = await fetch('/api/stop-queue-processing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('Failed to stop job');
        }

        log('[STOP] Stop requested - job will pause after current item completes\n');

      } catch (e) {
        log(`[ERROR] Error stopping job: ${e.message}\n`);
        alert(`Error stopping job: ${e.message}`);
      }
    }

    async function resumeJob() {
      try {
        log('[RESUME] Resuming job...\n');

        // Just call processQueue - it will pick up where we left off
        await processQueue();

      } catch (e) {
        log(`[ERROR] Error resuming job: ${e.message}\n`);
        alert(`Error resuming job: ${e.message}`);
      }
    }

    async function clearJob() {
      const confirm = window.confirm(
        '⚠️ CLEAR JOB\n\n' +
        'This will:\n' +
        '• Close short any incomplete MOs in Fishbowl\n' +
        '• Delete all pending records from the queue\n' +
        '• Log you out and reset the page\n\n' +
        'Are you sure you want to continue?'
      );

      if (!confirm) {
        log('[CLEAR] User cancelled clear operation\n');
        return;
      }

      try {
        log('[CLEAR] Clearing job and closing short MOs...\n');

        const configResponse = await fetch('/api/load-config');
        const config = await configResponse.json();

        const serverUrl = document.getElementById('serverUrl').value.trim();

        const response = await fetch('/api/clear-pending-jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: serverUrl,
            token: sessionToken,
            database: config.database
          })
        });

        if (!response.ok) {
          throw new Error('Failed to clear job');
        }

        const result = await response.json();

        log(`[CLEAR] Successfully closed short ${result.closedShortCount} MO(s)\n`);
        log(`[CLEAR] Deleted ${result.deletedCount} queue record(s)\n`);

        if (result.failedMOs && result.failedMOs.length > 0) {
          log(`[WARN] Failed to close short ${result.failedMOs.length} MO(s):\n`);
          result.failedMOs.forEach(mo => {
            log(`  - ${mo.moNum}: ${mo.error}\n`);
          });
        }

        alert(
          `✓ Clear Complete\n\n` +
          `Closed short: ${result.closedShortCount} MO(s)\n` +
          `Deleted: ${result.deletedCount} record(s)\n` +
          (result.failedMOs.length > 0 ? `\n⚠ Failed: ${result.failedMOs.length} MO(s) (see log)` : '') +
          `\n\nLogging out and resetting page...`
        );

        // Logout and reset
        await logout(false);

      } catch (e) {
        log(`[ERROR] Error clearing job: ${e.message}\n`);
        alert(`Error clearing job: ${e.message}`);
      }
    }

    let pollInterval = null;

    async function pollQueueStatus() {
      if (pollInterval) {
        clearInterval(pollInterval);
      }
      
      pollInterval = setInterval(async () => {
        try {
          const statusResponse = await fetch('/api/queue-status');
          const status = await statusResponse.json();

          document.getElementById('statusText').textContent = status.status.toUpperCase();
          document.getElementById('progressText').textContent = `${status.processedItems} / ${status.totalItems}`;
          document.getElementById('currentMO').textContent = status.currentMO || '-';
          document.getElementById('currentWO').textContent = status.currentWO || '-';

          const progress = status.totalItems > 0 ? Math.round((status.processedItems / status.totalItems) * 100) : 0;
          document.getElementById('progressBar').style.width = `${progress}%`;
          document.getElementById('progressPercent').textContent = `${progress}%`;

          // Calculate and display elapsed time
          if (status.startTime) {
            const startTime = new Date(status.startTime);
            const now = new Date();
            const elapsedMs = now - startTime;
            document.getElementById('timeElapsed').textContent = formatDuration(elapsedMs);

            // Calculate and display ETA (only after at least 3 items are processed)
            if (status.processedItems >= 3 && status.totalItems > status.processedItems) {
              const avgTimePerItem = elapsedMs / status.processedItems;
              const remainingItems = status.totalItems - status.processedItems;
              const estimatedRemainingMs = avgTimePerItem * remainingItems;
              document.getElementById('timeRemaining').textContent = formatDuration(estimatedRemainingMs);
            } else if (status.processedItems > 0 && status.totalItems > status.processedItems) {
              document.getElementById('timeRemaining').textContent = 'Calculating...';
            } else if (status.totalItems === status.processedItems) {
              document.getElementById('timeRemaining').textContent = '0s';
            }
          }
          
          if (status.status === 'stopped') {
            clearInterval(pollInterval);
            document.getElementById('progressBar').classList.remove('active');

            log(`\n${'='.repeat(60)}\nJOB STOPPED\n${'='.repeat(60)}\n`);
            log(`Progress: ${status.processedItems}/${status.totalItems}\n`);
            log(`Success: ${status.successItems}\n`);
            log(`Failed: ${status.failedItems}\n`);
            log(`Remaining: ${status.totalItems - status.processedItems}\n`);

            const stoppedHtml = `
              <div class="alert alert-warning">
                <h4><img src="images/x.svg" class="icon" alt="Stopped"> Job Stopped</h4>
                <hr>
                <p><strong>Total Items:</strong> ${status.totalItems}</p>
                <p><strong>Processed:</strong> ${status.processedItems}</p>
                <p><strong>Remaining:</strong> ${status.totalItems - status.processedItems}</p>
                <p><strong>Successful:</strong> <span class="text-success">${status.successItems}</span></p>
                <p><strong>Failed:</strong> <span class="text-danger">${status.failedItems}</span></p>
              </div>
              <div class="alert alert-info">
                <h5><img src="images/info.svg" class="icon" alt="Info"> What would you like to do?</h5>
                <p><strong>Resume:</strong> Continue processing the remaining ${status.totalItems - status.processedItems} item(s)</p>
                <p><strong>Clear:</strong> Close short incomplete MOs, delete queue records, logout and reset</p>
              </div>
              <div style="margin-top:15px;">
                <button id="btnResumeJob" class="btn btn-success btn-lg btn-block" style="margin-bottom:10px;">
                  <img src="images/play.svg" class="icon" alt="Resume"> Resume Job
                </button>
                <button id="btnClearJob" class="btn btn-danger btn-lg btn-block">
                  <img src="images/x.svg" class="icon" alt="Clear"> Clear Job & Logout
                </button>
              </div>
            `;

            document.getElementById('processResultContent').innerHTML = stoppedHtml;

            // Wire up buttons
            document.getElementById('btnResumeJob').addEventListener('click', resumeJob);
            document.getElementById('btnClearJob').addEventListener('click', clearJob);

            log('[JOB] Job stopped - waiting for user action (Resume or Clear)\n');

          } else if (status.status === 'completed' || status.status === 'error') {
            clearInterval(pollInterval);
            document.getElementById('progressBar').classList.remove('active');

            log(`\n${'='.repeat(60)}\nPROCESSING COMPLETE\n${'='.repeat(60)}\n`);
            log(`Status: ${status.status}\n`);
            log(`Total: ${status.totalItems}\n`);
            log(`Success: ${status.successItems}\n`);
            log(`Failed: ${status.failedItems}\n`);
            
            const finalHtml = `
              <div class="alert ${status.status === 'completed' ? 'alert-success' : 'alert-danger'}">
                <h4>${status.status === 'completed' ? '<img src="images/check.svg" class="icon" alt="Success"> Processing Complete!' : '<img src=\"images/x.svg\" class=\"icon\" alt=\"Error\"> Processing Failed'}</h4>
                <hr>
                <p><strong>Total Items:</strong> ${status.totalItems}</p>
                <p><strong>Successful:</strong> <span class="text-success">${status.successItems}</span></p>
                <p><strong>Failed:</strong> <span class="text-danger">${status.failedItems}</span></p>
                ${status.error ? `<p><strong>Error:</strong> ${status.error}</p>` : ''}
                <p><strong>Duration:</strong> ${calculateDuration(status.startTime, status.endTime)}</p>
              </div>
              <div style="margin-top:15px;">
                <h5>Results:</h5>
                <div style="max-height:400px; overflow-y:auto;">
                  ${status.results.map(r => `
                    <div class="alert ${r.status.includes('success') ? 'alert-success' : 'alert-danger'}" style="padding:8px; margin-bottom:5px;">
                      <strong>${r.status.includes('success') ? '<img src="images/check.svg" class="icon" alt="Success">' : '<img src="images/x.svg" class="icon" alt="Error">'}</strong> WO ${r.woNum} | Barcode ${r.barcode} | ${r.serials} serials
                      ${r.error ? `<br><small class="text-danger">${r.error}</small>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
              <div class="alert alert-info" style="margin-top:20px;">
                <strong><img src="images/check.svg" class="icon" alt="Complete"> Job Complete</strong><br>
                Review the results above. When ready, click the button below to logout and start a new job.
              </div>
              <div style="margin-top:15px;">
                ${status.failedItems > 0 ? `
                <button id="btnDownloadFailed" class="btn btn-warning btn-lg btn-block" style="margin-bottom:10px;">
                  <img src="images/save.svg" class="icon" alt="Download"> Download Failed Items (CSV)
                </button>
                ` : ''}
                <button id="btnCloseAndLogout" class="btn btn-primary btn-lg btn-block">
                  <img src="images/door.svg" class="icon" alt="Logout"> Close & Log Out
                </button>
              </div>
            `;
            
            document.getElementById('processResultContent').innerHTML = finalHtml;
            
            // Wire up the Download Failed Items button (if it exists)
            if (status.failedItems > 0) {
              document.getElementById('btnDownloadFailed').addEventListener('click', () => {
                downloadFailedItemsCSV(status.results);
              });
            }
            
            // Wire up the Close & Log Out button
            document.getElementById('btnCloseAndLogout').addEventListener('click', () => {
              log('[USER] Close & Log Out clicked\n');
              closeAndLogout();
            });
            
            // Show queue stats now that job is complete
            document.getElementById('queueStats').style.display = 'block';
            await updateQueueStats();
            
            log('[JOB] Processing complete - waiting for user to close\n');
          }
          
          
        } catch (e) {
          log(`[WARN] Status poll error: ${e.message}\n`);
        }
      }, 2000);
    }
    
    function calculateDuration(startTime, endTime) {
      if (!startTime || !endTime) return 'N/A';
      const start = new Date(startTime);
      const end = new Date(endTime);
      const diffMs = end - start;
      const diffMins = Math.floor(diffMs / 60000);
      const diffSecs = Math.floor((diffMs % 60000) / 1000);
      return `${diffMins}m ${diffSecs}s`;
    }

    function formatDuration(milliseconds) {
      if (!milliseconds || milliseconds < 0) return 'N/A';

      const totalSeconds = Math.floor(milliseconds / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;

      if (hours > 0) {
        return `${hours}h ${minutes}m ${seconds}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    // ============================================================================
    // JOB RESUMPTION ON PAGE LOAD
    // ============================================================================
    
    async function restoreSessionIfAvailable() {
      const storedSession = loadSessionFromStorage();
      
      if (!storedSession) {
        log('[SESSION] No stored session found\n');
        return false;
      }
      
      log('[SESSION] Found stored session, attempting to restore...\n');
      
      try {
        // Restore session variables
        sessionToken = storedSession.token;
        sessionCredentials = {
          username: storedSession.username,
          password: storedSession.password,
          database: storedSession.database || ''
        };
        
        // Restore UI fields
        document.getElementById('serverUrl').value = storedSession.serverUrl;
        document.getElementById('username').value = storedSession.username;
        document.getElementById('password').value = storedSession.password;
        
        // Test if token is still valid by making a simple query
        try {
          await fishbowlQuery('SELECT 1 as test');
          
          log('[SESSION] Session restored successfully\n');
          
          // Update UI to show logged in state
          document.getElementById('sessionStatus').innerHTML = 
            `<span class="text-success"><img src="images/check.svg" class="icon" alt="Success"> Logged in as ${storedSession.username} (restored)</span>`;
          document.getElementById('btnLogin').style.display = 'none';
          document.getElementById('btnLogout').style.display = 'inline-block';
          
          document.getElementById('serverUrl').disabled = true;
          document.getElementById('username').disabled = true;
          document.getElementById('password').disabled = true;
          
          // Enable Step 1 since we're logged in
          document.getElementById('step1').classList.remove('disabled');
          document.getElementById('step1').style.opacity = '1';
          document.getElementById('step1').style.pointerEvents = 'auto';
          $('#collapseStep1').collapse('show');

          // Check for pending jobs from previous interrupted run
          log('[SESSION] Checking for pending jobs from previous session...\n');
          const shouldResume = await checkForPendingJobs();

          if (shouldResume) {
            // User wants to resume - redirect to step 4 to process queue
            log('[SESSION] User chose to resume pending jobs\n');
            enableStep(4);
            await updateQueueStats();
            $('#collapseStep1').collapse('hide');
            $('#collapseStep4').collapse('show');
          }

          return true;
          
        } catch (testError) {
          log(`[SESSION] Stored token is invalid or expired: ${testError.message}\n`);
          clearSessionFromStorage();
          sessionToken = null;
          sessionCredentials = { username: '', password: '', database: '' };
          return false;
        }
        
      } catch (e) {
        log(`[SESSION] Failed to restore session: ${e.message}\n`);
        clearSessionFromStorage();
        return false;
      }
    }
    
    async function checkForPendingJobs() {
      try {
        const configResponse = await fetch('/api/load-config');
        const config = await configResponse.json();

        if (!config.database) {
          return false;
        }

        const response = await fetch('/api/check-pending-jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ database: config.database })
        });

        if (!response.ok) {
          throw new Error('Failed to check for pending jobs');
        }

        const result = await response.json();

        if (result.hasPendingJobs) {
          log(`[PENDING JOBS] Found ${result.pendingCount} pending item(s) in queue\n`);
          return await handlePendingJobs(result.pendingCount, config.database);
        }

        return false;

      } catch (error) {
        log(`[ERROR] Error checking for pending jobs: ${error.message}\n`);
        return false;
      }
    }

    async function handlePendingJobs(pendingCount, database) {
      const resume = confirm(
        `⚠️ PENDING JOBS DETECTED\n\n` +
        `There are ${pendingCount} pending work order(s) in the queue from a previous interrupted job.\n\n` +
        `Would you like to resume processing these items?\n\n` +
        `• Click OK to RESUME the job\n` +
        `• Click Cancel to CLOSE SHORT the MOs and mark items as closed`
      );

      if (resume) {
        log('[USER] User chose to RESUME pending job\n');
        return true; // Will trigger job resumption
      } else {
        log('[USER] User chose to CLOSE SHORT pending job\n');
        await closeShortPendingJobs(database);
        return false;
      }
    }

    async function closeShortPendingJobs(database) {
      try {
        log('[CLOSE SHORT] Starting close short process...\n');

        const serverUrl = document.getElementById('serverUrl').value.trim();

        if (!sessionToken) {
          throw new Error('Not logged in');
        }

        const response = await fetch('/api/close-short-pending-jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            serverUrl: serverUrl,
            token: sessionToken,
            database: database
          })
        });

        if (!response.ok) {
          throw new Error('Failed to close short pending jobs');
        }

        const result = await response.json();

        log(`[CLOSE SHORT] Successfully closed short ${result.closedShortCount} MO(s)\n`);
        log(`[CLOSE SHORT] Marked ${result.markedCount} queue item(s) as closed_short\n`);

        if (result.failedMOs && result.failedMOs.length > 0) {
          log(`[WARN] Failed to close short ${result.failedMOs.length} MO(s):\n`);
          result.failedMOs.forEach(mo => {
            log(`  - ${mo.moNum}: ${mo.error}\n`);
          });
        }

        alert(
          `✓ Close Short Complete\n\n` +
          `Closed short: ${result.closedShortCount} MO(s)\n` +
          `Marked as closed_short: ${result.markedCount} queue item(s)\n` +
          (result.failedMOs.length > 0 ? `\n⚠ Failed: ${result.failedMOs.length} MO(s) (see log)` : '')
        );

      } catch (error) {
        log(`[ERROR] Error closing short: ${error.message}\n`);
        alert(`Error closing short pending jobs:\n\n${error.message}`);
      }
    }

    async function checkAndResumeJob() {
      try {
        log('[RESUME] Checking for active jobs on server...\n');

        const statusResponse = await fetch('/api/queue-status');
        const status = await statusResponse.json();

        if (status.status === 'running') {
          log('\n' + '='.repeat(60) + '\n');
          log('<img src="images/lightning.svg" class="icon" alt="Fast"> RECONNECTED TO ACTIVE JOB\n');
          log('='.repeat(60) + '\n');
          log(`Progress: ${status.processedItems}/${status.totalItems}\n`);
          log(`Current MO: ${status.currentMO || 'N/A'}\n`);
          log(`Current WO: ${status.currentWO || 'N/A'}\n`);
          log('Resuming live monitoring...\n\n');
          
          // Show reconnection banner
          document.getElementById('reconnectBanner').style.display = 'block';
          
          // Grey out and disable login panel
          const configPanel = document.querySelector('.config-panel');
          configPanel.style.opacity = '0.6';
          configPanel.style.pointerEvents = 'none';
          
          document.getElementById('serverUrl').disabled = true;
          document.getElementById('username').disabled = true;
          document.getElementById('password').disabled = true;
          document.getElementById('btnLogin').disabled = true;
          
          // Show logged in status with restored session
          const username = sessionCredentials.username || 'Previous Session';
          document.getElementById('sessionStatus').innerHTML = `<span class="text-success"><img src="images/check.svg" class="icon" alt="Success"> Session restored (${username})</span>`;
          document.getElementById('btnLogout').style.display = 'inline-block';
          
          log('[INFO] Using restored session from previous login\n');
          
          // Grey out and disable all configuration steps - job is already running
          document.getElementById('step1').style.opacity = '0.6';
          document.getElementById('step1').style.pointerEvents = 'none';
          document.getElementById('step2').style.opacity = '0.6';
          document.getElementById('step2').style.pointerEvents = 'none';
          document.getElementById('step3').style.opacity = '0.6';
          document.getElementById('step3').style.pointerEvents = 'none';
          
          // Enable and show Step 4
          document.getElementById('step4').classList.remove('disabled');
          $('#collapseStep4').collapse('show');
          
          // Disable the Process Queue button (job already running)
          document.getElementById('btnProcess').disabled = true;
          document.getElementById('btnProcess').textContent = 'Job Already Running';
          document.getElementById('btnProcess').classList.remove('btn-warning');
          document.getElementById('btnProcess').classList.add('btn-default');
          
          // Hide queue stats during processing (can't retrieve mid-process stats from previous session)
          document.getElementById('queueStats').style.display = 'none';
          
          // Collapse other steps
          $('#collapseStep1').collapse('hide');
          $('#collapseStep2').collapse('hide');
          $('#collapseStep3').collapse('hide');
          
          // Show the progress UI
          const initialElapsed = status.startTime ? formatDuration(new Date() - new Date(status.startTime)) : '0s';
          const initialProgress = status.totalItems > 0 ? Math.round((status.processedItems / status.totalItems) * 100) : 0;

          document.getElementById('processResults').style.display = 'block';
          document.getElementById('processResultContent').innerHTML = `
            <div class="alert alert-info">
              <h4><img src="images/rocket.svg" class="icon" alt="Launch"> Resuming Job in Progress...</h4>
              <p><strong>Status:</strong> <span id="statusText">Running...</span></p>
              <p><strong>Progress:</strong> <span id="progressText">${status.processedItems} / ${status.totalItems}</span></p>
              <p><strong>Time Elapsed:</strong> <span id="timeElapsed">${initialElapsed}</span></p>
              <p><strong>Estimated Time Remaining:</strong> <span id="timeRemaining">Calculating...</span></p>
              <p><strong>Current MO:</strong> <span id="currentMO">${status.currentMO || '-'}</span></p>
              <p><strong>Current WO:</strong> <span id="currentWO">${status.currentWO || '-'}</span></p>
              <div class="progress" style="margin-top:10px;">
                <div id="progressBar" class="progress-bar progress-bar-striped active" style="width: ${initialProgress}%">
                  <span id="progressPercent">${initialProgress}%</span>
                </div>
              </div>
              <div style="margin-top:15px;">
                <button id="btnStopJob" class="btn btn-warning btn-sm"><img src="images/x.svg" class="icon" alt="Stop"> Stop Job</button>
              </div>
              <p style="margin-top:10px;"><small><img src="images/lightbulb.svg" class="icon" alt="Tip"> Job was already running on server - reconnected!</small></p>
            </div>
            <div id="resultsContainer"></div>`;

          // Wire up stop button
          document.getElementById('btnStopJob').addEventListener('click', stopJob);

          // Start polling
          pollQueueStatus();
          
          return true; // Job resumed
          
        } else if (status.status === 'stopped') {
          log(`[RESUME] Job was stopped\n`);
          log(`[INFO] Progress: ${status.processedItems}/${status.totalItems}\n`);
          log(`[INFO] Remaining: ${status.totalItems - status.processedItems} item(s)\n\n`);

          // Show stopped banner
          document.getElementById('reconnectBanner').innerHTML = `
            <strong><img src="images/warning.svg" class="icon" alt="Warning"> Job Was Stopped</strong><br>
            The previous job was stopped. ${status.totalItems - status.processedItems} item(s) remain pending.
          `;
          document.getElementById('reconnectBanner').style.display = 'block';
          document.getElementById('reconnectBanner').style.background = '#fff3cd';
          document.getElementById('reconnectBanner').style.borderLeft = '4px solid #ffc107';

          // Enable Step 4 to show stopped state
          document.getElementById('step4').classList.remove('disabled');
          $('#collapseStep4').collapse('show');

          // Show stopped UI
          document.getElementById('processResults').style.display = 'block';
          const stoppedHtml = `
            <div class="alert alert-warning">
              <h4><img src="images/x.svg" class="icon" alt="Stopped"> Job Stopped</h4>
              <hr>
              <p><strong>Total Items:</strong> ${status.totalItems}</p>
              <p><strong>Processed:</strong> ${status.processedItems}</p>
              <p><strong>Remaining:</strong> ${status.totalItems - status.processedItems}</p>
              <p><strong>Successful:</strong> <span class="text-success">${status.successItems}</span></p>
              <p><strong>Failed:</strong> <span class="text-danger">${status.failedItems}</span></p>
            </div>
            <div class="alert alert-info">
              <h5><img src="images/info.svg" class="icon" alt="Info"> What would you like to do?</h5>
              <p><strong>Resume:</strong> Continue processing the remaining ${status.totalItems - status.processedItems} item(s)</p>
              <p><strong>Clear:</strong> Close short incomplete MOs, delete queue records, logout and reset</p>
            </div>
            <div style="margin-top:15px;">
              <button id="btnResumeJob" class="btn btn-success btn-lg btn-block" style="margin-bottom:10px;">
                <img src="images/play.svg" class="icon" alt="Resume"> Resume Job
              </button>
              <button id="btnClearJob" class="btn btn-danger btn-lg btn-block">
                <img src="images/x.svg" class="icon" alt="Clear"> Clear Job & Logout
              </button>
            </div>
          `;

          document.getElementById('processResultContent').innerHTML = stoppedHtml;

          // Wire up buttons
          document.getElementById('btnResumeJob').addEventListener('click', resumeJob);
          document.getElementById('btnClearJob').addEventListener('click', clearJob);

          return false;

        } else if (status.status === 'completed' || status.status === 'error') {
          log(`[RESUME] Last job completed: ${status.status}\n`);
          log(`[INFO] Success: ${status.successItems}/${status.totalItems}\n\n`);

          // Show completion banner
          document.getElementById('reconnectBanner').innerHTML = `
            <strong><img src="images/info.svg" class="icon" alt="Info"> Previous Job Completed</strong><br>
            The last job has finished. You can start a new job now.
          `;
          document.getElementById('reconnectBanner').style.display = 'block';
          document.getElementById('reconnectBanner').style.background = '#d1ecf1';
          document.getElementById('reconnectBanner').style.borderLeft = '4px solid #17a2b8';

          // Hide banner after 5 seconds
          setTimeout(() => {
            document.getElementById('reconnectBanner').style.display = 'none';
          }, 5000);

          return false;

        } else {
          log('[RESUME] No active job found\n');
          return false;
        }
        
      } catch (e) {
        // Server might not be running yet, or no job - that's fine
        log(`[RESUME] No active job (${e.message})\n`);
        return false;
      }
    }
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', async () => {
      log('<img src="images/factory.svg" class="icon" alt="Factory"> Manufacturing Orchestrator (Queue-Based)\n' + '='.repeat(60) + '\n');
      log('<img src="images/lightning.svg" class="icon" alt="Fast"> Proxy server required: Run "node server.js" first\n');
      log('<img src="images/globe.svg" class="icon" alt="Web">  Then open http://localhost:3000/manufacturing-orchestrator.html\n');
      log('<img src="images/save.svg" class="icon" alt="Save"> Uses database queue for fault-tolerant processing\n\n');
      
      try {
        await loadConfig();
        
        // RESTORE SESSION FROM STORAGE (if available)
        const sessionRestored = await restoreSessionIfAvailable();
        
        if (sessionRestored) {
          log('[SESSION] Session restored from browser storage\n');
          
          // Load location groups since we're logged in
          try {
            await loadLocationGroups();
            log('[OK] Location groups loaded for restored session\n');
          } catch (e) {
            log(`[WARN] Could not load location groups: ${e.message}\n`);
          }
        }
        
        // CHECK FOR ACTIVE JOB IMMEDIATELY
        const jobResumed = await checkAndResumeJob();
        
        // Set up event listeners
        document.getElementById('btnLogin').addEventListener('click', login);
        document.getElementById('btnLogout').addEventListener('click', logout);
        document.getElementById('locationGroupSelect').addEventListener('change', onLocationGroupChange);
        document.getElementById('btnSelectBOM').addEventListener('click', selectBOM);

        // Step 1.5: Operation type selection
        document.getElementById('panelBuild').addEventListener('click', () => selectOperationType('build'));
        document.getElementById('panelDisassemble').addEventListener('click', () => selectOperationType('disassemble'));

        // Step 2: BUILD path (CSV)
        document.getElementById('csvFile').addEventListener('change', loadCSV);
        document.getElementById('btnValidate').addEventListener('click', validateAndPrepare);
        document.getElementById('btnSaveToQueue').addEventListener('click', saveToQueue);

        // Step 2B: DISASSEMBLE path (FG selection)
        document.getElementById('fgSearchBox').addEventListener('input', renderAvailableFGList);
        document.getElementById('btnAddSelectedFG').addEventListener('click', addSelectedFG);
        document.getElementById('btnAddAllFG').addEventListener('click', addAllFG);
        document.getElementById('btnRemoveSelectedFG').addEventListener('click', removeSelectedFG);
        document.getElementById('btnRemoveAllFG').addEventListener('click', removeAllFG);
        document.getElementById('fgReturnLocation').addEventListener('change', renderSelectedFGList);
        document.getElementById('btnConfirmDisassembly').addEventListener('click', confirmDisassembly);

        // Step 4: Process queue
        document.getElementById('btnProcess').addEventListener('click', processQueue);
        document.getElementById('btnClearLog').addEventListener('click', () => document.getElementById('log').textContent = 'Log cleared.\n');
        
        if (!jobResumed) {
          if (sessionRestored) {
            log('<img src="images/check.svg" class="icon" alt="Success"> Session restored! You can continue working or start a new job.\n');
          } else {
            log('<img src="images/check.svg" class="icon" alt="Success"> Ready! Enter your Fishbowl credentials and click Login to begin.\n');
          }
        }
      } catch (err) {
        log(`[ERROR] Initialization error: ${err.message}\n`);
        console.error('Init error:', err);
      }
    });
  </script>
</body>
</html>
